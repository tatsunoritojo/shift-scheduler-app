<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±ç”¨ã‚·ãƒ•ãƒˆå¯èƒ½æ—¥è¨ˆç®—ã‚¢ãƒ—ãƒª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .settings-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #2196F3;
        }

        .settings-panel h3 {
            color: #1976D2;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1em;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .form-control-small {
            width: 120px;
            display: inline-block;
            margin-right: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            border-color: #2196F3;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #2196F3;
        }

        .checkbox-item.checked {
            background: #e3f2fd;
            border-color: #2196F3;
        }

        .time-range {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
        }

        .btn-success:hover {
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        }

        .preset-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .preset-btn {
            background: #e3f2fd;
            color: #1976D2;
            border: 2px solid #2196F3;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .preset-btn:hover {
            background: #2196F3;
            color: white;
            transform: translateY(-1px);
        }

        .advanced-settings {
            background: #fff3e0;
            border-left: 5px solid #FF9800;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .advanced-settings h4 {
            color: #F57F17;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .results-section {
            margin-top: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 5px solid #FF9800;
            display: none;
        }

        .results-section.show {
            display: block;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .shift-result {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .shift-result:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .shift-result.available {
            border-left: 5px solid #4CAF50;
            background: linear-gradient(90deg, #e8f5e8 0%, white 100%);
        }

        .shift-result.partial {
            border-left: 5px solid #FF9800;
            background: linear-gradient(90deg, #fff3e0 0%, white 100%);
        }

        .shift-result.unavailable {
            border-left: 5px solid #f44336;
            background: linear-gradient(90deg, #ffebee 0%, white 100%);
        }

        .date-info {
            font-weight: 600;
            font-size: 1.1em;
            color: #333;
        }

        /* ON/OFFãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .shift-toggle-btn {
            position: relative;
            width: 70px;
            height: 35px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            font-size: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            outline: none;
        }

        .shift-toggle-btn.on {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .shift-toggle-btn.off {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }

        .shift-toggle-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .shift-toggle-btn:active {
            transform: scale(0.95);
        }

        /* ç„¡åŠ¹åŒ–ã•ã‚ŒãŸã‚·ãƒ•ãƒˆçµæœã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .shift-result.disabled {
            opacity: 0.6;
            background: linear-gradient(90deg, #f5f5f5 0%, white 100%);
            border-left-color: #bdbdbd;
        }

        .shift-result.disabled .time-badge {
            opacity: 0.7;
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã§ã®ON/OFFçŠ¶æ…‹ */
        .calendar-day.calendar-disabled {
            opacity: 0.5;
            background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
        }

        .calendar-day.calendar-disabled .time-slot {
            opacity: 0.6;
            text-decoration: line-through;
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ« */
        .calendar-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 25px;
            z-index: 1000;
            min-width: 300px;
            text-align: center;
        }

        .calendar-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .calendar-popup h3 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 1.2em;
        }

        .calendar-popup .date-display {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 20px;
        }

        .calendar-popup .toggle-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .calendar-popup button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .calendar-popup .close-btn {
            background: #f44336;
            color: white;
        }

        .calendar-popup .close-btn:hover {
            background: #d32f2f;
        }

        .time-badge {
            background: #2196F3;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .time-badge.partial {
            background: #FF9800;
        }

        .time-badge.unavailable {
            background: #f44336;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2196F3;
            display: block;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .current-settings {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #4CAF50;
        }

        .current-settings h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .setting-item {
            display: inline-block;
            background: white;
            padding: 5px 10px;
            margin: 3px;
            border-radius: 15px;
            font-size: 0.9em;
            border: 1px solid #c8e6c9;
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
            
            .preset-buttons {
                justify-content: center;
            }
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 15px 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #555;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px; /* border-bottomã¨é‡ãªã‚‰ãªã„ã‚ˆã†ã« */
        }

        .tab-button:hover {
            color: #2196F3;
        }

        .tab-button.active {
            color: #2196F3;
            border-bottom-color: #2196F3;
            font-weight: 600;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
        .month-container {
            margin-bottom: 40px;
        }

        .month-title {
            font-size: 1.8em;
            font-weight: 600;
            color: #1976D2;
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .calendar-header {
            background: #1976D2;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 0.9em;
        }

        .calendar-day {
            background: white;
            padding: 15px;
            text-align: center;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .calendar-day:hover {
            background: #f5f5f5;
        }

        .calendar-day.empty {
            background: #f8f9fa;
            color: #ccc;
        }

        .calendar-day.available {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            font-weight: bold;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .calendar-day.unavailable {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #e57373;
        }

        .calendar-day.excluded {
            background: #f5f5f5;
            color: #999;
            border: 1px solid #e0e0e0;
        }

        .time-slot {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 4px;
            line-height: 1.2;
        }

        .calendar-day.unavailable .time-slot,
        .calendar-day.excluded .time-slot {
            color: rgba(0, 0, 0, 0.6);
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .legend-available {
            background: linear-gradient(135deg, #4CAF50, #45a049);
        }

        .legend-unavailable {
            background: #c62828;
        }

        .legend-excluded {
            background: #999;
        }

        @media (max-width: 768px) {
            .calendar-grid {
                padding: 10px;
            }
            
            .calendar-day {
                padding: 10px;
                min-height: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ æ±ç”¨ã‚·ãƒ•ãƒˆå¯èƒ½æ—¥è¨ˆç®—ã‚¢ãƒ—ãƒª</h1>
            <p>ã‚ã‚‰ã‚†ã‚‹å‹¤å‹™æ¡ä»¶ã«å¯¾å¿œã§ãã‚‹æŸ”è»Ÿãªã‚·ãƒ•ãƒˆè¨ˆç®—ãƒ„ãƒ¼ãƒ«</p>
        </div>

        <div class="content">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('settings-tab')">è¨­å®š</button>
                <button class="tab-button" onclick="showTab('results-tab')">çµæœ</button>
            </div>

            <div class="tab-content">
                <div id="settings-tab" class="tab-pane active">
                    <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
            <div class="preset-buttons">
                <button class="preset-btn" onclick="loadPreset('student')">ğŸ‘¨â€ğŸ“ å­¦ç”Ÿãƒã‚¤ãƒˆ</button>
                <button class="preset-btn" onclick="loadPreset('office')">ğŸ¢ ã‚ªãƒ•ã‚£ã‚¹å‹¤å‹™</button>
                <button class="preset-btn" onclick="loadPreset('retail')">ğŸ›’ å°å£²åº—</button>
                <button class="preset-btn" onclick="loadPreset('restaurant')">ğŸ½ï¸ é£²é£Ÿåº—</button>
                <button class="preset-btn" onclick="loadPreset('flexible')">âš¡ ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹</button>
                <button class="preset-btn" onclick="resetSettings()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
            </div>

            <!-- ç¾åœ¨ã®è¨­å®šè¡¨ç¤º -->
            <div class="current-settings" id="currentSettings">
                <h4>ğŸ“‹ ç¾åœ¨ã®è¨­å®š</h4>
                <div id="settingsDisplay"></div>
            </div>

            <!-- è¨­å®šãƒ‘ãƒãƒ« -->
            <div class="settings-grid">
                <!-- åŸºæœ¬è¨­å®š -->
                <div class="settings-panel">
                    <h3>â° åŸºæœ¬å‹¤å‹™æ¡ä»¶</h3>
                    
                    <div class="form-group">
                        <label>å–¶æ¥­æ™‚é–“</label>
                        <div class="time-range">
                            <input type="time" id="startTime" class="form-control form-control-small" value="10:00">
                            <span>ã€œ</span>
                            <input type="time" id="endTime" class="form-control form-control-small" value="18:00">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="tooltip" data-tooltip="é€£ç¶šã—ã¦å‹¤å‹™ã§ãã‚‹æœ€ä½æ™‚é–“">
                            æœ€ä½å‹¤å‹™æ™‚é–“ â“˜
                        </label>
                        <div class="time-range">
                            <input type="number" id="minHours" class="form-control form-control-small" value="2" min="0.5" step="0.5">
                            <span>æ™‚é–“</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="tooltip" data-tooltip="äºˆå®šã®å‰å¾Œã«ç¢ºä¿ã™ã‚‹ç§»å‹•ãƒ»æº–å‚™æ™‚é–“">
                            ç§»å‹•æ™‚é–“ â“˜
                        </label>
                        <div class="time-range">
                            <input type="number" id="bufferTime" class="form-control form-control-small" value="30" min="0" step="15">
                            <span>åˆ†</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>é™¤å¤–ã™ã‚‹æ›œæ—¥</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude0" onchange="updateCheckboxUI(this)">
                                <label for="exclude0">æ—¥</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude1" onchange="updateCheckboxUI(this)">
                                <label for="exclude1">æœˆ</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude2" onchange="updateCheckboxUI(this)">
                                <label for="exclude2">ç«</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude3" onchange="updateCheckboxUI(this)">
                                <label for="exclude3">æ°´</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude4" onchange="updateCheckboxUI(this)">
                                <label for="exclude4">æœ¨</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude5" onchange="updateCheckboxUI(this)">
                                <label for="exclude5">é‡‘</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude6" onchange="updateCheckboxUI(this)">
                                <label for="exclude6">åœŸ</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æœŸé–“ãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨­å®š -->
                <div class="settings-panel">
                    <h3>ğŸ“… æœŸé–“ãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨­å®š</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDate">é–‹å§‹æ—¥</label>
                            <input type="date" id="startDate" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="endDate">çµ‚äº†æ—¥</label>
                            <input type="date" id="endDate" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="calendarId" class="tooltip" data-tooltip="ç©ºæ¬„ã®å ´åˆã¯ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ä½¿ç”¨">
                            ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID â“˜
                        </label>
                        <input type="text" id="calendarId" class="form-control" placeholder="primary" value="primary">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="submitterName">æå‡ºè€…æ°å</label>
                            <input type="text" id="submitterName" class="form-control" placeholder="ä¾‹ï¼šç”°ä¸­ å¤ªéƒ" value="">
                        </div>
                        <div class="form-group">
                            <label for="submitterDepartment">æ‰€å±éƒ¨ç½²</label>
                            <input type="text" id="submitterDepartment" class="form-control" placeholder="ä¾‹ï¼šã‚¢ãƒ«ãƒã‚¤ãƒˆã‚¹ã‚¿ãƒƒãƒ•" value="">
                        </div>
                    </div>

                    <!-- é«˜åº¦ãªè¨­å®š -->
                    <div class="advanced-settings">
                        <h4>âš™ï¸ é«˜åº¦ãªè¨­å®š</h4>
                        
                        <div class="form-group">
                            <label class="tooltip" data-tooltip="ã“ã®æ™‚é–“æœªæº€ã®ç©ºãæ™‚é–“ã¯ç„¡è¦–">
                                æœ€å°ç©ºãæ™‚é–“ â“˜
                            </label>
                            <div class="time-range">
                                <input type="number" id="minGapTime" class="form-control form-control-small" value="30" min="0" step="15">
                                <span>åˆ†</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="tooltip" data-tooltip="1æ—¥ã®æœ€å¤§å‹¤å‹™æ™‚é–“åˆ¶é™">
                                æœ€å¤§å‹¤å‹™æ™‚é–“ â“˜
                            </label>
                            <div class="time-range">
                                <input type="number" id="maxHours" class="form-control form-control-small" value="8" min="1" max="12" step="0.5">
                                <span>æ™‚é–“</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="allowSplitShifts" onchange="updateCheckboxUI(this)">
                                <label for="allowSplitShifts" class="tooltip" data-tooltip="1æ—¥ã«è¤‡æ•°ã®æ™‚é–“å¸¯ã§å‹¤å‹™å¯èƒ½">
                                    åˆ†å‰²ã‚·ãƒ•ãƒˆè¨±å¯ â“˜
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="excludeHolidays" onchange="updateCheckboxUI(this)">
                                <label for="excludeHolidays" class="tooltip" data-tooltip="æ—¥æœ¬ã®ç¥æ—¥ã‚’å‡ºå‹¤ä¸å¯ã«ã™ã‚‹">
                                    ç¥æ—¥ã‚’å‡ºå‹¤ä¸å¯ã«ã™ã‚‹ â“˜
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- èªè¨¼ãƒ»å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
            <div style="text-align: center; margin: 30px 0;">
                <button class="btn btn-success" onclick="authenticateGoogle()" id="authButton">
                    ğŸ” Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼
                </button>
                <button class="btn" onclick="calculateShifts()" id="calculateButton" disabled>
                    ğŸ”„ ã‚·ãƒ•ãƒˆå¯èƒ½æ—¥ã‚’è¨ˆç®—
                </button>
                <button class="btn btn-secondary" onclick="saveSettings()">
                    ğŸ’¾ è¨­å®šã‚’ä¿å­˜
                </button>
                <button class="btn btn-secondary" onclick="loadSettings()">
                    ğŸ“‚ è¨­å®šã‚’èª­è¾¼
                </button>
            </div>
                </div>

                <div id="results-tab" class="tab-pane">
                    <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div id="resultsSection" class="results-section">
                        <div id="loadingDiv" class="loading">
                            <div class="spinner"></div>
                            <p>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã‚’å–å¾—ä¸­...</p>
                        </div>
                        
                        <div id="resultsContent" style="display: none;">
                            <h3>ğŸ“Š è¨ˆç®—çµæœ</h3>
                            <div id="summaryStats" class="summary-stats"></div>
                            
                            <!-- è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
                            <div style="text-align: center; margin: 20px 0;">
                                <button class="preset-btn" onclick="showResultView('calendar')" id="calendarViewBtn">
                                    ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º
                                </button>
                                <button class="preset-btn" onclick="showResultView('list')" id="listViewBtn">
                                    ğŸ“‹ ãƒªã‚¹ãƒˆè¡¨ç¤º
                                </button>
                            </div>
                            
                            <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                            <div id="calendarView" style="display: none;">
                                <!-- æå‡ºè€…æƒ…å ±ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                                <div id="submitterHeader" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid #2196F3;">
                                    <h3 style="margin: 0 0 15px 0; color: #1976D2;">ğŸ“… ã‚·ãƒ•ãƒˆå¸Œæœ›æå‡ºæ›¸</h3>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="text-align: left;">
                                            <div style="font-size: 1.1em; margin-bottom: 5px;">
                                                <strong>æ°åï¼š</strong> <span id="displaySubmitterName">æœªå…¥åŠ›</span>
                                            </div>
                                            <div style="font-size: 1em; opacity: 0.8;">
                                                <strong>æ‰€å±ï¼š</strong> <span id="displaySubmitterDepartment">æœªå…¥åŠ›</span>
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 1em; opacity: 0.8;">
                                                <strong>æå‡ºæ—¥ï¼š</strong> <span id="displaySubmissionDate"></span>
                                            </div>
                                            <div style="font-size: 1em; opacity: 0.8; margin-top: 5px;">
                                                <strong>å¯¾è±¡æœŸé–“ï¼š</strong> <span id="displayDateRange"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- å‡¡ä¾‹ -->
                                <div class="legend">
                                    <div class="legend-item">
                                        <div class="legend-color legend-available"></div>
                                        <span>å‡ºå‹¤å¯èƒ½</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color legend-unavailable"></div>
                                        <span>å‡ºå‹¤ä¸å¯</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color legend-excluded"></div>
                                        <span>é™¤å¤–æ—¥</span>
                                    </div>
                                </div>
                                
                                <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ã‚³ãƒ³ãƒ†ãƒŠ -->
                                <div id="calendar-container"></div>
                            </div>
                            
                            <!-- ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                            <div id="listView">
                                <div id="shiftResults"></div>
                            </div>
                            
                            <div style="text-align: center; margin-top: 30px;">
                                <button class="btn btn-success" onclick="exportToPDF()">
                                    ğŸ“„ PDFå‡ºåŠ›
                                </button>
                                <button class="btn btn-secondary" onclick="exportToCSV()">
                                    ğŸ“Š CSVå‡ºåŠ›
                                </button>
                                <button class="btn" onclick="testWithDummyData()" style="background: #FF9800; margin-left: 10px;">
                                    ğŸ§ª ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã§ãƒ†ã‚¹ãƒˆ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Googleèªè¨¼
        function authenticateGoogle() {
            window.location.href = '/auth/google/login';
        }

        // èªè¨¼çŠ¶æ…‹ç¢ºèª
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/debug/auth-check');
                const authButton = document.getElementById('authButton');
                const calculateButton = document.getElementById('calculateButton');
                
                if (response.ok) {
                    const authData = await response.json();
                    
                    if (authData.authenticated) {
                        // èªè¨¼æ¸ˆã¿
                        authButton.style.display = 'none';
                        calculateButton.disabled = false;
                        
                        // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                        console.log('èªè¨¼æ¸ˆã¿:', authData);
                    } else {
                        // æœªèªè¨¼
                        authButton.style.display = 'inline-flex';
                        authButton.textContent = 'ğŸ” Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼';
                        calculateButton.disabled = true;
                        
                        console.log('æœªèªè¨¼:', authData);
                    }
                } else {
                    // APIã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯æœªèªè¨¼ã¨ã—ã¦æ‰±ã†
                    authButton.style.display = 'inline-flex';
                    authButton.textContent = 'ğŸ” Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼';
                    calculateButton.disabled = true;
                    
                    console.warn('èªè¨¼çŠ¶æ…‹ç¢ºèªAPIã§ã‚¨ãƒ©ãƒ¼:', response.status);
                }
            } catch (error) {
                console.log('èªè¨¼çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯èªè¨¼ãŒå¿…è¦ã¨ä»®å®š
                document.getElementById('authButton').style.display = 'inline-flex';
                document.getElementById('authButton').textContent = 'ğŸ” Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼';
                document.getElementById('calculateButton').disabled = true;
            }
        }

        // èªè¨¼çŠ¶æ…‹ã‚’å¼·åˆ¶çš„ã«ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        function resetAuthStatus() {
            const authButton = document.getElementById('authButton');
            const calculateButton = document.getElementById('calculateButton');
            
            authButton.style.display = 'inline-flex';
            authButton.textContent = 'ğŸ” Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼';
            calculateButton.disabled = true;
            
            console.log('èªè¨¼çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            
            // 2é€±é–“å¾Œã‚’çµ‚äº†æ—¥ã«è¨­å®š
            const twoWeeksLater = new Date();
            twoWeeksLater.setDate(twoWeeksLater.getDate() + 14);
            document.getElementById('endDate').value = twoWeeksLater.toISOString().split('T')[0];

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ°´æ›œã¨æ—¥æ›œã‚’é™¤å¤–
            document.getElementById('exclude0').checked = true;
            document.getElementById('exclude3').checked = true;
            updateAllCheckboxUI();
            
            updateSettingsDisplay();
            
            // è¨­å®šå¤‰æ›´æ™‚ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
            document.addEventListener('input', updateSettingsDisplay);
            document.addEventListener('change', updateSettingsDisplay);

            // åˆæœŸè¡¨ç¤ºã¯è¨­å®šã‚¿ãƒ–
            showTab('settings-tab');

            // èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
            checkAuthStatus();
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function showTab(tabId) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤ºã«ã—ã€activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // æŒ‡å®šã•ã‚ŒãŸã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºã—ã€activeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');

            // çµæœã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ã‚ã£ãŸéš›ã«resultsSectionã‚’è¡¨ç¤º
            if (tabId === 'results-tab') {
                document.getElementById('resultsSection').classList.add('show');
            } else {
                document.getElementById('resultsSection').classList.remove('show');
            }
        }

        // ãƒ—ãƒªã‚»ãƒƒãƒˆè¨­å®š
        const presets = {
            student: {
                startTime: '10:00',
                endTime: '18:00',
                minHours: 2,
                bufferTime: 30,
                excludeDays: [0, 3], // æ—¥æ›œã€æ°´æ›œ
                maxHours: 8,
                minGapTime: 30,
                allowSplitShifts: false,
                excludeHolidays: false
            },
            office: {
                startTime: '09:00',
                endTime: '18:00',
                minHours: 4,
                bufferTime: 15,
                excludeDays: [0, 6], // æ—¥æ›œã€åœŸæ›œ
                maxHours: 8,
                minGapTime: 60,
                allowSplitShifts: false,
                excludeHolidays: false
            },
            retail: {
                startTime: '10:00',
                endTime: '20:00',
                minHours: 3,
                bufferTime: 15,
                excludeDays: [],
                maxHours: 8,
                minGapTime: 30,
                allowSplitShifts: true,
                excludeHolidays: false
            },
            restaurant: {
                startTime: '11:00',
                endTime: '22:00',
                minHours: 2,
                bufferTime: 30,
                excludeDays: [],
                maxHours: 8,
                minGapTime: 30,
                allowSplitShifts: true,
                excludeHolidays: false
            },
            flexible: {
                startTime: '08:00',
                endTime: '20:00',
                minHours: 1,
                bufferTime: 0,
                excludeDays: [],
                maxHours: 12,
                minGapTime: 0,
                allowSplitShifts: true,
                excludeHolidays: false
            }
        };

        // ãƒ—ãƒªã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿
        function loadPreset(presetName) {
            const preset = presets[presetName];
            if (!preset) return;

            document.getElementById('startTime').value = preset.startTime;
            document.getElementById('endTime').value = preset.endTime;
            document.getElementById('minHours').value = preset.minHours;
            document.getElementById('bufferTime').value = preset.bufferTime;
            document.getElementById('maxHours').value = preset.maxHours;
            document.getElementById('minGapTime').value = preset.minGapTime;
            document.getElementById('allowSplitShifts').checked = preset.allowSplitShifts;
            document.getElementById('excludeHolidays').checked = preset.excludeHolidays;

            // æ›œæ—¥é™¤å¤–è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ
            for (let i = 0; i < 7; i++) {
                document.getElementById(`exclude${i}`).checked = preset.excludeDays.includes(i);
            }

            updateAllCheckboxUI();
            updateSettingsDisplay();
        }

        // è¨­å®šãƒªã‚»ãƒƒãƒˆ
        function resetSettings() {
            document.getElementById('startTime').value = '09:00';
            document.getElementById('endTime').value = '17:00';
            document.getElementById('minHours').value = '2';
            document.getElementById('bufferTime').value = '30';
            document.getElementById('maxHours').value = '8';
            document.getElementById('minGapTime').value = '30';
            document.getElementById('allowSplitShifts').checked = false;
            document.getElementById('excludeHolidays').checked = false;

            for (let i = 0; i < 7; i++) {
                document.getElementById(`exclude${i}`).checked = false;
            }

            updateAllCheckboxUI();
            updateSettingsDisplay();
        }

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®UIæ›´æ–°
        function updateCheckboxUI(checkbox) {
            const item = checkbox.closest('.checkbox-item');
            if (checkbox.checked) {
                item.classList.add('checked');
            } else {
                item.classList.remove('checked');
            }
        }

        function updateAllCheckboxUI() {
            for (let i = 0; i < 7; i++) {
                updateCheckboxUI(document.getElementById(`exclude${i}`));
            }
            updateCheckboxUI(document.getElementById('allowSplitShifts'));
            updateCheckboxUI(document.getElementById('excludeHolidays'));
        }

        // ç¾åœ¨ã®è¨­å®šè¡¨ç¤ºã‚’æ›´æ–°
        function updateSettingsDisplay() {
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const minHours = document.getElementById('minHours').value;
            const bufferTime = document.getElementById('bufferTime').value;
            const maxHours = document.getElementById('maxHours').value;
            const minGapTime = document.getElementById('minGapTime').value;
            const allowSplitShifts = document.getElementById('allowSplitShifts').checked;
            const excludeHolidays = document.getElementById('excludeHolidays').checked;

            const excludedDays = [];
            const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            for (let i = 0; i < 7; i++) {
                if (document.getElementById(`exclude${i}`).checked) {
                    excludedDays.push(dayNames[i]);
                }
            }

            const displayHTML = `
                <span class="setting-item">â° ${startTime}ã€œ${endTime}</span>
                <span class="setting-item">â±ï¸ æœ€ä½${minHours}æ™‚é–“</span>
                <span class="setting-item">ğŸš¶ ç§»å‹•${bufferTime}åˆ†</span>
                <span class="setting-item">ğŸ“Š æœ€å¤§${maxHours}æ™‚é–“</span>
                <span class="setting-item">âš¡ æœ€å°ç©ºã${minGapTime}åˆ†</span>
                ${excludedDays.length > 0 ? `<span class="setting-item">ğŸš« ${excludedDays.join('ãƒ»')}æ›œæ—¥é™¤å¤–</span>` : ''}
                ${allowSplitShifts ? '<span class="setting-item">âœ‚ï¸ åˆ†å‰²ã‚·ãƒ•ãƒˆå¯</span>' : ''}
                ${excludeHolidays ? '<span class="setting-item">ğŸŒ ç¥æ—¥é™¤å¤–</span>' : ''}
            `;

            document.getElementById('settingsDisplay').innerHTML = displayHTML;
        }

        // è¨­å®šã®ä¿å­˜
        function saveSettings() {
            const settings = {
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                minHours: document.getElementById('minHours').value,
                bufferTime: document.getElementById('bufferTime').value,
                maxHours: document.getElementById('maxHours').value,
                minGapTime: document.getElementById('minGapTime').value,
                allowSplitShifts: document.getElementById('allowSplitShifts').checked,
                excludeHolidays: document.getElementById('excludeHolidays').checked,
                excludedDays: []
            };

            for (let i = 0; i < 7; i++) {
                if (document.getElementById(`exclude${i}`).checked) {
                    settings.excludedDays.push(i);
                }
            }

            localStorage.setItem('shiftCalculatorSettings', JSON.stringify(settings));
            alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        }

        // è¨­å®šã®èª­ã¿è¾¼ã¿
        function loadSettings() {
            const saved = localStorage.getItem('shiftCalculatorSettings');
            if (!saved) {
                alert('ä¿å­˜ã•ã‚ŒãŸè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            const settings = JSON.parse(saved);
            
            document.getElementById('startTime').value = settings.startTime;
            document.getElementById('endTime').value = settings.endTime;
            document.getElementById('minHours').value = settings.minHours;
            document.getElementById('bufferTime').value = settings.bufferTime;
            document.getElementById('maxHours').value = settings.maxHours;
            document.getElementById('minGapTime').value = settings.minGapTime;
            document.getElementById('allowSplitShifts').checked = settings.allowSplitShifts;
            document.getElementById('excludeHolidays').checked = settings.excludeHolidays;

            for (let i = 0; i < 7; i++) {
                document.getElementById(`exclude${i}`).checked = settings.excludedDays.includes(i);
            }

            updateAllCheckboxUI();
            updateSettingsDisplay();
            alert('è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼');
        }

        // ç¾åœ¨ã®è¨­å®šã‚’å–å¾—
        function getCurrentSettings() {
            const excludedDays = [];
            for (let i = 0; i < 7; i++) {
                if (document.getElementById(`exclude${i}`).checked) {
                    excludedDays.push(i);
                }
            }

            return {
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                minHours: parseFloat(document.getElementById('minHours').value),
                bufferTime: parseInt(document.getElementById('bufferTime').value),
                maxHours: parseFloat(document.getElementById('maxHours').value),
                minGapTime: parseInt(document.getElementById('minGapTime').value),
                allowSplitShifts: document.getElementById('allowSplitShifts').checked,
                excludeHolidays: document.getElementById('excludeHolidays').checked,
                excludedDays: excludedDays
            };
        }

        // ã‚·ãƒ•ãƒˆè¨ˆç®—ã®ãƒ¡ã‚¤ãƒ³é–¢æ•°
        async function calculateShifts() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const calendarId = document.getElementById('calendarId').value || 'primary';
            const settings = getCurrentSettings();

            if (!startDate || !endDate) {
                alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // çµæœã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
            showTab('results-tab');
            
            // çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.add('show');
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            document.getElementById('loadingDiv').style.display = 'block';
            document.getElementById('resultsContent').style.display = 'none';

            try {
                // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã‚’å–å¾—
                await fetchCalendarDataFromBackend(startDate, endDate, calendarId, settings);
            } catch (error) {
                console.error('ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚èªè¨¼ãŒå¿…è¦ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                document.getElementById('loadingDiv').style.display = 'none';
            }
        }

        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã‚’å–å¾—
        async function fetchCalendarDataFromBackend(startDate, endDate, calendarId, settings) {
            try {
                // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã‚’å‘¼ã³å‡ºã—ã¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
                const response = await fetch(`/api/calendar/events?startDate=${startDate}&endDate=${endDate}&calendarId=${calendarId}`);
                
                if (response.status === 401) {
                    // èªè¨¼ãŒåˆ‡ã‚ŒãŸå ´åˆã€èªè¨¼ãƒœã‚¿ãƒ³ã‚’å†è¡¨ç¤º
                    const authButton = document.getElementById('authButton');
                    const calculateButton = document.getElementById('calculateButton');
                    authButton.style.display = 'inline-flex';
                    authButton.textContent = 'ğŸ” Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼';
                    calculateButton.disabled = true;
                    
                    // èªè¨¼ãŒå¿…è¦ãªå ´åˆ
                    const authConfirm = confirm('èªè¨¼ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†èªè¨¼ãŒå¿…è¦ã§ã™ã€‚èªè¨¼ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ');
                    if (authConfirm) {
                        window.location.href = '/auth/google/login';
                    }
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const events = await response.json();
                console.log('å–å¾—ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆ:', events);
                
                // å–å¾—ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½¿ã£ã¦ã‚·ãƒ•ãƒˆã‚’è¨ˆç®—
                await calculateShiftsWithRealData(startDate, endDate, events, settings);
                
            } catch (error) {
                console.error('ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
                throw error;
            }
        }

        // å®Ÿéš›ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ãŸã‚·ãƒ•ãƒˆè¨ˆç®—
        async function calculateShiftsWithRealData(startDate, endDate, events, settings) {
            let holidays = {};
            if (settings.excludeHolidays) {
                try {
                    const startYear = new Date(startDate).getFullYear();
                    const endYear = new Date(endDate).getFullYear();
                    for (let year = startYear; year <= endYear; year++) {
                        const response = await fetch(`https://holidays-jp.github.io/api/v1/${year}/date.json`);
                        if (response.ok) {
                            const yearHolidays = await response.json();
                            holidays = { ...holidays, ...yearHolidays };
                        }
                    }
                } catch (error) {
                    console.error("Error fetching holidays:", error);
                }
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const eventsByDate = {};
            events.forEach(event => {
                const eventDate = event.start.includes('T') ? 
                    event.start.split('T')[0] : event.start;
                
                if (!eventsByDate[eventDate]) {
                    eventsByDate[eventDate] = [];
                }
                
                // çµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
                if (event.start.includes('T') && event.end.includes('T')) {
                    eventsByDate[eventDate].push({
                        start: event.start.split('T')[1].substring(0, 5),
                        end: event.end.split('T')[1].substring(0, 5),
                        summary: event.summary
                    });
                }
            });

            // è¨­å®šã«åŸºã¥ã„ã¦ã‚·ãƒ•ãƒˆã‚’è¨ˆç®—
            const shifts = calculateShiftsWithRealEvents(startDate, endDate, eventsByDate, settings, holidays);
            displayResults(shifts, settings);
        }

        // å®Ÿéš›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ãŸã‚·ãƒ•ãƒˆè¨ˆç®—
        function calculateShiftsWithRealEvents(startDate, endDate, eventsByDate, settings, holidays) {
            const shifts = [];
            const start = new Date(startDate);
            const end = new Date(endDate);

            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                const dayOfWeek = date.getDay();
                const dateStr = date.toISOString().split('T')[0];
                const dayName = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][dayOfWeek];

                // é™¤å¤–æ›œæ—¥ãƒã‚§ãƒƒã‚¯
                if (settings.excludedDays.includes(dayOfWeek)) {
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'excluded',
                        reason: `${dayName}æ›œæ—¥ã®ãŸã‚å¯¾è±¡å¤–`,
                        availableTime: null,
                        duration: 0,
                        shifts: []
                    });
                    continue;
                }

                // ç¥æ—¥é™¤å¤–ãƒã‚§ãƒƒã‚¯
                if (settings.excludeHolidays && holidays[dateStr]) {
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'excluded',
                        reason: `ç¥æ—¥ï¼ˆ${holidays[dateStr]}ï¼‰ã®ãŸã‚å¯¾è±¡å¤–`,
                        availableTime: null,
                        duration: 0,
                        shifts: []
                    });
                    continue;
                }

                // ãã®æ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
                const dayEvents = eventsByDate[dateStr] || [];
                
                // å–¶æ¥­æ™‚é–“å†…ã®åˆ©ç”¨å¯èƒ½æ™‚é–“ã‚’è¨ˆç®—
                const availableSlots = calculateAvailableSlots(
                    settings.startTime,
                    settings.endTime,
                    dayEvents,
                    settings
                );

                // æœ€ä½å‹¤å‹™æ™‚é–“ã‚’æº€ãŸã™ã‚¹ãƒ­ãƒƒãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const validSlots = availableSlots.filter(slot => slot.duration >= settings.minHours);

                if (validSlots.length > 0) {
                    const totalDuration = validSlots.reduce((sum, slot) => sum + slot.duration, 0);
                    const maxDuration = Math.min(totalDuration, settings.maxHours);

                    if (settings.allowSplitShifts && validSlots.length > 1) {
                        shifts.push({
                            date: dateStr,
                            dayName: dayName,
                            status: 'available',
                            reason: 'è¤‡æ•°æ™‚é–“å¸¯ã§å‹¤å‹™å¯èƒ½',
                            availableTime: validSlots.map(slot => `${slot.start}-${slot.end}`).join(', '),
                            duration: maxDuration,
                            shifts: validSlots
                        });
                    } else {
                        const bestSlot = validSlots[0];
                        const adjustedEnd = maxDuration < bestSlot.duration ? 
                            addHours(bestSlot.start, maxDuration) : bestSlot.end;
                        
                        shifts.push({
                            date: dateStr,
                            dayName: dayName,
                            status: 'available',
                            reason: 'å‹¤å‹™å¯èƒ½',
                            availableTime: `${bestSlot.start}-${adjustedEnd}`,
                            duration: Math.min(bestSlot.duration, maxDuration),
                            shifts: [{ start: bestSlot.start, end: adjustedEnd, duration: Math.min(bestSlot.duration, maxDuration) }]
                        });
                    }
                } else {
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'unavailable',
                        reason: dayEvents.length > 0 ? 'äºˆå®šã«ã‚ˆã‚Šæœ€ä½å‹¤å‹™æ™‚é–“ç¢ºä¿ä¸å¯' : 'å‹¤å‹™æ™‚é–“ç¢ºä¿ä¸å¯',
                        availableTime: null,
                        duration: 0,
                        shifts: []
                    });
                }
            }

            return shifts;
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å–å¾—ã¨ã‚·ãƒ•ãƒˆè¨ˆç®—ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
        async function simulateCalendarFetch(startDate, endDate, calendarId, settings) {
            await new Promise(resolve => setTimeout(resolve, 2000));

            let holidays = {};
            if (settings.excludeHolidays) {
                try {
                    const startYear = new Date(startDate).getFullYear();
                    const endYear = new Date(endDate).getFullYear();
                    for (let year = startYear; year <= endYear; year++) {
                        const response = await fetch(`https://holidays-jp.github.io/api/v1/${year}/date.json`);
                        if (!response.ok) {
                            throw new Error(`Failed to fetch holidays for ${year}: ${response.statusText}`);
                        }
                        const yearHolidays = await response.json();
                        holidays = { ...holidays, ...yearHolidays };
                    }
                    console.log("Fetched holidays:", holidays);
                } catch (error) {
                    console.error("Error fetching holidays:", error);
                    alert("ç¥æ—¥æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç¥æ—¥é™¤å¤–è¨­å®šã¯é©ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚");
                }
            }

            // è¨­å®šã«åŸºã¥ã„ã¦ã‚·ãƒ•ãƒˆã‚’è¨ˆç®—
            const shifts = calculateShiftsWithSettings(startDate, endDate, settings, holidays);
            displayResults(shifts, settings);
        }

        // è¨­å®šã«åŸºã¥ãã‚·ãƒ•ãƒˆè¨ˆç®—
        function calculateShiftsWithSettings(startDate, endDate, settings, holidays) {
            const shifts = [];
            const start = new Date(startDate);
            const end = new Date(endDate);

            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                const dayOfWeek = date.getDay();
                const dateStr = date.toISOString().split('T')[0];
                const dayName = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][dayOfWeek];

                // é™¤å¤–æ›œæ—¥ãƒã‚§ãƒƒã‚¯
                if (settings.excludedDays.includes(dayOfWeek)) {
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'excluded',
                        reason: `${dayName}æ›œæ—¥ã®ãŸã‚å¯¾è±¡å¤–`,
                        availableTime: null,
                        duration: 0,
                        shifts: []
                    });
                    continue;
                }

                // ç¥æ—¥é™¤å¤–ãƒã‚§ãƒƒã‚¯
                if (settings.excludeHolidays && holidays[dateStr]) {
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'excluded',
                        reason: `ç¥æ—¥ï¼ˆ${holidays[dateStr]}ï¼‰ã®ãŸã‚å¯¾è±¡å¤–`,
                        availableTime: null,
                        duration: 0,
                        shifts: []
                    });
                    continue;
                }

                // ãƒ©ãƒ³ãƒ€ãƒ ã«äºˆå®šã‚’ç”Ÿæˆï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
                const hasEvent = Math.random() < 0.4; // 40%ã®ç¢ºç‡ã§äºˆå®šã‚ã‚Š
                let availableSlots = [];

                if (hasEvent) {
                    // äºˆå®šãŒã‚ã‚‹å ´åˆã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                    const eventStart = randomTime(settings.startTime, settings.endTime);
                    const eventDuration = Math.random() * 4 + 1; // 1-5æ™‚é–“ã®äºˆå®š
                    const eventEnd = addHours(eventStart, eventDuration);

                    // å–¶æ¥­æ™‚é–“å†…ã®åˆ©ç”¨å¯èƒ½æ™‚é–“ã‚’è¨ˆç®—
                    availableSlots = calculateAvailableSlots(
                        settings.startTime,
                        settings.endTime,
                        [{start: eventStart, end: eventEnd}],
                        settings
                    );
                } else {
                    // äºˆå®šãŒãªã„å ´åˆã¯å…¨æ™‚é–“åˆ©ç”¨å¯èƒ½
                    availableSlots = [{
                        start: settings.startTime,
                        end: settings.endTime,
                        duration: calculateDuration(settings.startTime, settings.endTime)
                    }];
                }

                // æœ€ä½å‹¤å‹™æ™‚é–“ã‚’æº€ãŸã™ã‚¹ãƒ­ãƒƒãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const validSlots = availableSlots.filter(slot => slot.duration >= settings.minHours);

                if (validSlots.length > 0) {
                    const totalDuration = validSlots.reduce((sum, slot) => sum + slot.duration, 0);
                    const maxDuration = Math.min(totalDuration, settings.maxHours);

                    if (settings.allowSplitShifts && validSlots.length > 1) {
                        shifts.push({
                            date: dateStr,
                            dayName: dayName,
                            status: 'available',
                            reason: 'è¤‡æ•°æ™‚é–“å¸¯ã§å‹¤å‹™å¯èƒ½',
                            availableTime: validSlots.map(slot => `${slot.start}-${slot.end}`).join(', '),
                            duration: maxDuration,
                            shifts: validSlots
                        });
                    } else {
                        const bestSlot = validSlots[0];
                        const adjustedEnd = maxDuration < bestSlot.duration ? 
                            addHours(bestSlot.start, maxDuration) : bestSlot.end;
                        
                        shifts.push({
                            date: dateStr,
                            dayName: dayName,
                            status: 'available',
                            reason: 'å‹¤å‹™å¯èƒ½',
                            availableTime: `${bestSlot.start}-${adjustedEnd}`,
                            duration: Math.min(bestSlot.duration, maxDuration),
                            shifts: [{ start: bestSlot.start, end: adjustedEnd, duration: Math.min(bestSlot.duration, maxDuration) }]
                        });
                    }
                } else {
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'unavailable',
                        reason: hasEvent ? 'äºˆå®šã«ã‚ˆã‚Šæœ€ä½å‹¤å‹™æ™‚é–“ç¢ºä¿ä¸å¯' : 'å‹¤å‹™æ™‚é–“ç¢ºä¿ä¸å¯',
                        availableTime: null,
                        duration: 0,
                        shifts: []
                    });
                }
            }

            return shifts;
        }

        // åˆ©ç”¨å¯èƒ½æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆè¨ˆç®—
        function calculateAvailableSlots(startTime, endTime, events, settings) {
            const slots = [];
            const workStart = timeToMinutes(startTime);
            const workEnd = timeToMinutes(endTime);

            // ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ™‚é–“é †ã«ã‚½ãƒ¼ãƒˆ
            events.sort((a, b) => timeToMinutes(a.start) - timeToMinutes(b.start));

            let currentStart = workStart;

            for (const event of events) {
                const eventStart = Math.max(workStart, timeToMinutes(event.start) - settings.bufferTime);
                const eventEnd = Math.min(workEnd, timeToMinutes(event.end) + settings.bufferTime);

                if (currentStart < eventStart) {
                    const slotDuration = (eventStart - currentStart) / 60;
                    if (slotDuration >= settings.minGapTime / 60) {
                        slots.push({
                            start: minutesToTime(currentStart),
                            end: minutesToTime(eventStart),
                            duration: slotDuration
                        });
                    }
                }

                currentStart = Math.max(currentStart, eventEnd);
            }

            // æœ€å¾Œã®ã‚¹ãƒ­ãƒƒãƒˆ
            if (currentStart < workEnd) {
                const slotDuration = (workEnd - currentStart) / 60;
                if (slotDuration >= settings.minGapTime / 60) {
                    slots.push({
                        start: minutesToTime(currentStart),
                        end: minutesToTime(workEnd),
                        duration: slotDuration
                    });
                }
            }

            return slots;
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        function calculateDuration(startTime, endTime) {
            return (timeToMinutes(endTime) - timeToMinutes(startTime)) / 60;
        }

        function addHours(timeStr, hours) {
            const startMinutes = timeToMinutes(timeStr);
            const endMinutes = startMinutes + (hours * 60);
            return minutesToTime(Math.round(endMinutes));
        }

        function randomTime(startTime, endTime) {
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = timeToMinutes(endTime);
            const randomMinutes = startMinutes + Math.random() * (endMinutes - startMinutes);
            return minutesToTime(Math.round(randomMinutes));
        }

        // çµæœè¡¨ç¤º
        function displayResults(shifts, settings) {
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('resultsContent').style.display = 'block';

            // çµ±è¨ˆè¨ˆç®—
            const availableShifts = shifts.filter(s => s.status === 'available');
            const partialShifts = shifts.filter(s => s.status === 'partial');
            const unavailableShifts = shifts.filter(s => s.status === 'unavailable');
            const excludedShifts = shifts.filter(s => s.status === 'excluded');
            const totalHours = availableShifts.reduce((sum, s) => sum + s.duration, 0);
            const avgHoursPerDay = availableShifts.length > 0 ? (totalHours / availableShifts.length) : 0;

            // çµ±è¨ˆè¡¨ç¤º
            const statsHtml = `
                <div class="stat-card">
                    <span class="stat-number">${availableShifts.length}</span>
                    <div class="stat-label">å‡ºå‹¤å¯èƒ½æ—¥</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${totalHours.toFixed(1)}</span>
                    <div class="stat-label">åˆè¨ˆå‹¤å‹™æ™‚é–“</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${avgHoursPerDay.toFixed(1)}</span>
                    <div class="stat-label">å¹³å‡å‹¤å‹™æ™‚é–“/æ—¥</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${unavailableShifts.length}</span>
                    <div class="stat-label">å‡ºå‹¤ä¸å¯æ—¥</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${excludedShifts.length}</span>
                    <div class="stat-label">é™¤å¤–æ—¥</div>
                </div>
            `;
            document.getElementById('summaryStats').innerHTML = statsHtml;

            // ã‚·ãƒ•ãƒˆçµæœè¡¨ç¤º
            const resultsHtml = shifts.map((shift, index) => {
                const statusClass = shift.status === 'excluded' ? 'unavailable' : shift.status;
                const statusIcon = {
                    'available': 'âœ…',
                    'partial': 'âš ï¸',
                    'unavailable': 'âŒ',
                    'excluded': 'ğŸš«'
                }[shift.status];

                const timeDisplay = shift.availableTime ? 
                    `<span class="time-badge ${statusClass}">${shift.availableTime} (${shift.duration.toFixed(1)}h)</span>` :
                    `<span class="time-badge unavailable">${shift.reason}</span>`;

                // ON/OFFãƒœã‚¿ãƒ³ï¼ˆåˆ©ç”¨å¯èƒ½æ—¥ã®ã¿ï¼‰
                const toggleButton = (shift.status === 'available' || shift.status === 'partial') ? 
                    `<button class="shift-toggle-btn on" id="toggle-${index}" onclick="toggleShiftDay(${index})" data-enabled="true">
                        <span class="toggle-text">ON</span>
                    </button>` : '';

                return `
                    <div class="shift-result ${statusClass}" id="shift-${index}">
                        <div class="date-info">
                            ${statusIcon} ${shift.date} (${shift.dayName})
                        </div>
                        ${timeDisplay}
                        ${toggleButton}
                    </div>
                `;
            }).join('');

            document.getElementById('shiftResults').innerHTML = resultsHtml;

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            window.currentShiftsData = shifts;
            window.currentStartDate = document.getElementById('startDate').value;
            window.currentEndDate = document.getElementById('endDate').value;

            // ã‚·ãƒ•ãƒˆé¸æŠçŠ¶æ…‹ã‚’åˆæœŸåŒ–ï¼ˆå…¨ã¦ONï¼‰
            window.shiftSelectionState = shifts.map((shift, index) => ({
                index: index,
                enabled: shift.status === 'available' || shift.status === 'partial',
                shift: shift
            }));

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒªã‚¹ãƒˆè¡¨ç¤ºã‚’é¸æŠ
            showResultView('list');
        }

        // ã‚·ãƒ•ãƒˆæ—¥ã®ON/OFFåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        function toggleShiftDay(index) {
            const button = document.getElementById(`toggle-${index}`);
            const shiftResult = document.getElementById(`shift-${index}`);
            const isEnabled = button.getAttribute('data-enabled') === 'true';
            
            if (isEnabled) {
                // ONã‹ã‚‰OFFã¸
                button.setAttribute('data-enabled', 'false');
                button.className = 'shift-toggle-btn off';
                button.querySelector('.toggle-text').textContent = 'OFF';
                shiftResult.classList.add('disabled');
                
                // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
                window.shiftSelectionState[index].enabled = false;
            } else {
                // OFFã‹ã‚‰ONã¸
                button.setAttribute('data-enabled', 'true');
                button.className = 'shift-toggle-btn on';
                button.querySelector('.toggle-text').textContent = 'ON';
                shiftResult.classList.remove('disabled');
                
                // é¸æŠçŠ¶æ…‹ã‚’æ›´æ–°
                window.shiftSelectionState[index].enabled = true;
            }
            
            // çµ±è¨ˆã‚’æ›´æ–°
            updateShiftStatistics();
        }

        // çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
        function updateShiftStatistics() {
            const enabledShifts = window.shiftSelectionState.filter(s => s.enabled && s.shift.status === 'available');
            const enabledPartialShifts = window.shiftSelectionState.filter(s => s.enabled && s.shift.status === 'partial');
            const totalEnabledShifts = enabledShifts.length + enabledPartialShifts.length;
            const totalHours = enabledShifts.reduce((sum, s) => sum + (s.shift.duration || 0), 0) + 
                              enabledPartialShifts.reduce((sum, s) => sum + (s.shift.duration || 0), 0);
            const avgHoursPerDay = totalEnabledShifts > 0 ? (totalHours / totalEnabledShifts) : 0;

            // çµ±è¨ˆè¡¨ç¤ºã‚’æ›´æ–°
            const statsHtml = `
                <div class="stat-card">
                    <span class="stat-number">${totalEnabledShifts}</span>
                    <div class="stat-label">é¸æŠæ¸ˆã¿å‡ºå‹¤å¯èƒ½æ—¥</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${totalHours.toFixed(1)}</span>
                    <div class="stat-label">é¸æŠæ¸ˆã¿åˆè¨ˆå‹¤å‹™æ™‚é–“</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${avgHoursPerDay.toFixed(1)}</span>
                    <div class="stat-label">å¹³å‡å‹¤å‹™æ™‚é–“/æ—¥</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${enabledShifts.length}</span>
                    <div class="stat-label">ãƒ•ãƒ«å‹¤å‹™å¯èƒ½æ—¥</div>
                </div>
            `;
            
            document.getElementById('summaryStats').innerHTML = statsHtml;
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã‚‚æ›´æ–°
            updateCalendarDisplay();
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã®æ›´æ–°
        function updateCalendarDisplay() {
            if (window.currentShiftsData && document.getElementById('calendarView').style.display !== 'none') {
                renderCalendar(window.currentStartDate, window.currentEndDate, window.currentShiftsData);
            }
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ã®ON/OFFãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
        function showCalendarTogglePopup(index, dateStr, cellElement) {
            const shiftData = window.shiftSelectionState[index];
            if (!shiftData) return;

            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ä½œæˆ
            const overlay = document.createElement('div');
            overlay.className = 'calendar-popup-overlay';
            
            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ
            const popup = document.createElement('div');
            popup.className = 'calendar-popup';
            
            const date = new Date(dateStr);
            const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const dayName = dayNames[date.getDay()];
            
            popup.innerHTML = `
                <h3>ã‚·ãƒ•ãƒˆè¨­å®š</h3>
                <div class="date-display">${dateStr} (${dayName})</div>
                <div class="shift-info">
                    ${shiftData.shift.availableTime ? 
                        `å‹¤å‹™å¯èƒ½æ™‚é–“: ${shiftData.shift.availableTime}` : 
                        'å‹¤å‹™æ™‚é–“æƒ…å ±ãªã—'}
                </div>
                <div class="toggle-controls">
                    <button class="shift-toggle-btn ${shiftData.enabled ? 'on' : 'off'}" 
                            onclick="toggleFromCalendar(${index})">
                        <span class="toggle-text">${shiftData.enabled ? 'ON' : 'OFF'}</span>
                    </button>
                </div>
                <div>
                    <button class="close-btn" onclick="closeCalendarPopup()">é–‰ã˜ã‚‹</button>
                </div>
            `;
            
            // DOMã«è¿½åŠ 
            document.body.appendChild(overlay);
            document.body.appendChild(popup);
            
            // ã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
            overlay.addEventListener('click', closeCalendarPopup);
            
            // ç¾åœ¨ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¦ç´ ã‚’ä¿å­˜
            window.currentCalendarPopup = { overlay, popup, index };
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ã®ON/OFFåˆ‡ã‚Šæ›¿ãˆ
        function toggleFromCalendar(index) {
            // ãƒªã‚¹ãƒˆè¡¨ç¤ºã®ãƒœã‚¿ãƒ³ã¨åŒæœŸ
            toggleShiftDay(index);
            
            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
            const popupButton = document.querySelector('.calendar-popup .shift-toggle-btn');
            const isEnabled = window.shiftSelectionState[index].enabled;
            
            popupButton.className = `shift-toggle-btn ${isEnabled ? 'on' : 'off'}`;
            popupButton.querySelector('.toggle-text').textContent = isEnabled ? 'ON' : 'OFF';
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
        function closeCalendarPopup() {
            if (window.currentCalendarPopup) {
                document.body.removeChild(window.currentCalendarPopup.overlay);
                document.body.removeChild(window.currentCalendarPopup.popup);
                window.currentCalendarPopup = null;
            }
        }

        // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        function showResultView(viewType) {
            const calendarView = document.getElementById('calendarView');
            const listView = document.getElementById('listView');
            const calendarBtn = document.getElementById('calendarViewBtn');
            const listBtn = document.getElementById('listViewBtn');

            if (viewType === 'calendar') {
                calendarView.style.display = 'block';
                listView.style.display = 'none';
                calendarBtn.style.background = '#2196F3';
                calendarBtn.style.color = 'white';
                listBtn.style.background = '#e3f2fd';
                listBtn.style.color = '#1976D2';

                // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»
                if (window.currentShiftsData) {
                    updateSubmitterInfo();
                    renderCalendar(window.currentStartDate, window.currentEndDate, window.currentShiftsData);
                }
            } else {
                calendarView.style.display = 'none';
                listView.style.display = 'block';
                listBtn.style.background = '#2196F3';
                listBtn.style.color = 'white';
                calendarBtn.style.background = '#e3f2fd';
                calendarBtn.style.color = '#1976D2';
            }
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»é–¢æ•°
        function renderCalendar(startDate, endDate, shiftData) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’Mapã«å¤‰æ›ï¼ˆé«˜é€Ÿæ¤œç´¢ç”¨ï¼‰
            const shiftMap = new Map();
            shiftData.forEach((shift, index) => {
                shiftMap.set(shift.date, { ...shift, originalIndex: index });
            });
            
            // æœˆã”ã¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ç”Ÿæˆ
            const container = document.getElementById('calendar-container');
            container.innerHTML = '';
            
            const months = getMonthsInRange(start, end);
            months.forEach(month => {
                const monthContainer = createMonthCalendar(month, shiftMap);
                container.appendChild(monthContainer);
            });
        }

        // æŒ‡å®šã•ã‚ŒãŸæœŸé–“ã«å«ã¾ã‚Œã‚‹æœˆã®ãƒªã‚¹ãƒˆã‚’å–å¾—
        function getMonthsInRange(start, end) {
            const months = [];
            const current = new Date(start.getFullYear(), start.getMonth(), 1);
            const endMonth = new Date(end.getFullYear(), end.getMonth(), 1);
            
            while (current <= endMonth) {
                months.push(new Date(current));
                current.setMonth(current.getMonth() + 1);
            }
            
            return months;
        }

        // æœˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ç”Ÿæˆ
        function createMonthCalendar(month, shiftMap) {
            const monthContainer = document.createElement('div');
            monthContainer.className = 'month-container';
            
            // æœˆã‚¿ã‚¤ãƒˆãƒ«
            const monthTitle = document.createElement('div');
            monthTitle.className = 'month-title';
            monthTitle.textContent = `${month.getFullYear()}å¹´${month.getMonth() + 1}æœˆ`;
            monthContainer.appendChild(monthTitle);
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰
            const grid = document.createElement('div');
            grid.className = 'calendar-grid';
            
            // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            weekdays.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // æœˆã®æœ€åˆã®æ—¥ã®æ›œæ—¥ã‚’å–å¾—
            const firstDay = new Date(month.getFullYear(), month.getMonth(), 1);
            const startDayOfWeek = firstDay.getDay();
            
            // æœˆã®æœ€å¾Œã®æ—¥ã‚’å–å¾—
            const lastDay = new Date(month.getFullYear(), month.getMonth() + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // æœ€åˆã®é€±ã®ç©ºã®ã‚»ãƒ«ã‚’è¿½åŠ 
            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day empty';
                grid.appendChild(emptyCell);
            }
            
            // æ—¥ä»˜ã‚»ãƒ«ã‚’è¿½åŠ 
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = createDayCell(month.getFullYear(), month.getMonth(), day, shiftMap);
                grid.appendChild(dayCell);
            }
            
            monthContainer.appendChild(grid);
            return monthContainer;
        }

        // æ—¥ä»˜ã‚»ãƒ«ã‚’ç”Ÿæˆ
        function createDayCell(year, month, day, shiftMap) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day';
            
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const shiftData = shiftMap.get(dateStr);
            
            // æ—¥ä»˜ç•ªå·
            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = day;
            cell.appendChild(dayNumber);
            
            // ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
            if (shiftData) {
                const originalIndex = shiftData.originalIndex;
                const isEnabled = window.shiftSelectionState && 
                                 window.shiftSelectionState[originalIndex] && 
                                 window.shiftSelectionState[originalIndex].enabled;
                
                // åŸºæœ¬ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                cell.classList.add(shiftData.status);
                
                // ON/OFFçŠ¶æ…‹ã«åŸºã¥ã„ã¦è¡¨ç¤ºã‚’èª¿æ•´
                if (shiftData.status === 'available' || shiftData.status === 'partial') {
                    if (!isEnabled) {
                        cell.classList.add('calendar-disabled');
                    }
                    
                    // ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹
                    cell.style.cursor = 'pointer';
                    cell.setAttribute('data-shift-index', originalIndex);
                    cell.setAttribute('data-date', dateStr);
                    
                    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
                    cell.addEventListener('click', () => showCalendarTogglePopup(originalIndex, dateStr, cell));
                }
                
                // åˆ©ç”¨å¯èƒ½æ™‚é–“ã‚’è¡¨ç¤º
                if (shiftData.availableTime) {
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot';
                    timeSlot.textContent = shiftData.availableTime;
                    cell.appendChild(timeSlot);
                }
            }
            
            return cell;
        }

        // æå‡ºè€…æƒ…å ±ã‚’æ›´æ–°
        function updateSubmitterInfo() {
            const submitterName = document.getElementById('submitterName').value || 'æœªå…¥åŠ›';
            const submitterDepartment = document.getElementById('submitterDepartment').value || 'æœªå…¥åŠ›';
            const today = new Date().toLocaleDateString('ja-JP');
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                return date.toLocaleDateString('ja-JP');
            };
            
            document.getElementById('displaySubmitterName').textContent = submitterName;
            document.getElementById('displaySubmitterDepartment').textContent = submitterDepartment;
            document.getElementById('displaySubmissionDate').textContent = today;
            document.getElementById('displayDateRange').textContent = `${formatDate(startDate)} ã€œ ${formatDate(endDate)}`;
        }

        // PDFå‡ºåŠ›
        function exportToPDF() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const settings = getCurrentSettings();
            
            alert(`${startDate}ã€œ${endDate}ã®ã‚·ãƒ•ãƒˆå¯èƒ½æ—¥ã‚’PDFå‡ºåŠ›ã—ã¾ã™ã€‚\nè¨­å®š: ${settings.startTime}ã€œ${settings.endTime}, æœ€ä½${settings.minHours}æ™‚é–“å‹¤å‹™\nï¼ˆå®Ÿè£…äºˆå®šæ©Ÿèƒ½ï¼‰`);
        }

        // CSVå‡ºåŠ›
        function exportToCSV() {
            const shifts = Array.from(document.querySelectorAll('.shift-result')).map(el => {
                const dateInfo = el.querySelector('.date-info').textContent.trim();
                const timeInfo = el.querySelector('.time-badge').textContent.trim();
                return { date: dateInfo, time: timeInfo };
            });

            const csvContent = "data:text/csv;charset=utf-8," + 
                "æ—¥ä»˜,æ™‚é–“å¸¯\n" +
                shifts.map(row => `"${row.date}","${row.time}"`).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "shift_schedule.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã§ãƒ†ã‚¹ãƒˆ
        function testWithDummyData() {
            // 2é€±é–“åˆ†ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
            const startDate = new Date();
            const endDate = new Date();
            endDate.setDate(startDate.getDate() + 13); // 2é€±é–“å¾Œ
            
            // æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const startDateStr = startDate.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0];
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«æ—¥ä»˜ã‚’è¨­å®š
            document.getElementById('startDate').value = startDateStr;
            document.getElementById('endDate').value = endDateStr;
            
            // ãƒ€ãƒŸãƒ¼ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
            const dummyShifts = generateDummyShifts(startDateStr, endDateStr);
            
            // çµæœã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
            showTab('results-tab');
            
            // çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.add('show');
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            document.getElementById('loadingDiv').style.display = 'block';
            document.getElementById('resultsContent').style.display = 'none';
            
            // 2ç§’å¾Œã«çµæœã‚’è¡¨ç¤ºï¼ˆå®Ÿéš›ã®å‡¦ç†ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
            setTimeout(() => {
                displayResults(dummyShifts, getCurrentSettings());
            }, 2000);
        }

        // ãƒ€ãƒŸãƒ¼ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        function generateDummyShifts(startDate, endDate) {
            const shifts = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            const settings = getCurrentSettings();
            
            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                const dayOfWeek = date.getDay();
                const dateStr = date.toISOString().split('T')[0];
                const dayName = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][dayOfWeek];
                
                // é™¤å¤–æ›œæ—¥ãƒã‚§ãƒƒã‚¯
                if (settings.excludedDays.includes(dayOfWeek)) {
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'excluded',
                        reason: `${dayName}æ›œæ—¥ã®ãŸã‚å¯¾è±¡å¤–`,
                        availableTime: null,
                        duration: 0,
                        shifts: []
                    });
                    continue;
                }
                
                // ãƒ©ãƒ³ãƒ€ãƒ ã«çŠ¶æ³ã‚’æ±ºå®š
                const random = Math.random();
                
                if (random < 0.6) { // 60%ã®ç¢ºç‡ã§å‡ºå‹¤å¯èƒ½
                    const workHours = Math.random() * (settings.maxHours - settings.minHours) + settings.minHours;
                    const startHour = Math.floor(Math.random() * 4) + 9; // 9-12æ™‚é–‹å§‹
                    const startTime = `${startHour.toString().padStart(2, '0')}:00`;
                    const endTime = addHours(startTime, workHours);
                    
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'available',
                        reason: 'å‹¤å‹™å¯èƒ½',
                        availableTime: `${startTime}-${endTime}`,
                        duration: workHours,
                        shifts: [{ start: startTime, end: endTime, duration: workHours }]
                    });
                } else if (random < 0.8) { // 20%ã®ç¢ºç‡ã§å‡ºå‹¤ä¸å¯
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'unavailable',
                        reason: 'äºˆå®šã«ã‚ˆã‚Šå‹¤å‹™ä¸å¯',
                        availableTime: null,
                        duration: 0,
                        shifts: []
                    });
                } else { // 20%ã®ç¢ºç‡ã§åˆ†å‰²ã‚·ãƒ•ãƒˆï¼ˆåˆ†å‰²ã‚·ãƒ•ãƒˆè¨±å¯æ™‚ï¼‰
                    if (settings.allowSplitShifts) {
                        const morning = { start: '10:00', end: '12:00', duration: 2 };
                        const afternoon = { start: '15:00', end: '18:00', duration: 3 };
                        
                        shifts.push({
                            date: dateStr,
                            dayName: dayName,
                            status: 'available',
                            reason: 'åˆ†å‰²ã‚·ãƒ•ãƒˆã§å‹¤å‹™å¯èƒ½',
                            availableTime: '10:00-12:00, 15:00-18:00',
                            duration: 5,
                            shifts: [morning, afternoon]
                        });
                    } else {
                        shifts.push({
                            date: dateStr,
                            dayName: dayName,
                            status: 'available',
                            reason: 'å‹¤å‹™å¯èƒ½',
                            availableTime: '13:00-17:00',
                            duration: 4,
                            shifts: [{ start: '13:00', end: '17:00', duration: 4 }]
                        });
                    }
                }
            }
            
            return shifts;
        }
    </script>
</body>
</html>