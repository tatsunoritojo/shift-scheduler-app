<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±ç”¨ã‚·ãƒ•ãƒˆå¯èƒ½æ—¥è¨ˆç®—ã‚¢ãƒ—ãƒª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .settings-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #2196F3;
        }

        .settings-panel h3 {
            color: #1976D2;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1em;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .form-control-small {
            width: 120px;
            display: inline-block;
            margin-right: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            border-color: #2196F3;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #2196F3;
        }

        .checkbox-item.checked {
            background: #e3f2fd;
            border-color: #2196F3;
        }

        .time-range {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
        }

        .btn-success:hover {
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        }


        .advanced-settings {
            background: #fff3e0;
            border-left: 5px solid #FF9800;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .advanced-settings h4 {
            color: #F57F17;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .results-section {
            margin-top: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 5px solid #FF9800;
            display: none;
        }

        .results-section.show {
            display: block;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .shift-result {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .shift-result:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .shift-result.available {
            border-left: 5px solid #4CAF50;
            background: linear-gradient(90deg, #e8f5e8 0%, white 100%);
        }

        .shift-result.partial {
            border-left: 5px solid #FF9800;
            background: linear-gradient(90deg, #fff3e0 0%, white 100%);
        }

        .shift-result.unavailable {
            border-left: 5px solid #f44336;
            background: linear-gradient(90deg, #ffebee 0%, white 100%);
        }

        .date-info {
            font-weight: 600;
            font-size: 1.1em;
            color: #333;
        }

        .time-badge {
            background: #2196F3;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .time-badge.partial {
            background: #FF9800;
        }

        .time-badge.unavailable {
            background: #f44336;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2196F3;
            display: block;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .current-settings {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #4CAF50;
        }

        .current-settings h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .setting-item {
            display: inline-block;
            background: white;
            padding: 5px 10px;
            margin: 3px;
            border-radius: 15px;
            font-size: 0.9em;
            border: 1px solid #c8e6c9;
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
            
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 13px;
            white-space: normal;
            max-width: 300px;
            width: max-content;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            line-height: 1.4;
        }

        .tooltip:hover::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #2c3e50;
            z-index: 1001;
        }

        /* ãƒœã‚¿ãƒ³ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ« */
        button[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
        input[title]:hover::after {
            content: attr(title);
            position: absolute;
            top: -35px;
            left: 0;
            background: #2c3e50;
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 15px 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #555;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px; /* border-bottomã¨é‡ãªã‚‰ãªã„ã‚ˆã†ã« */
        }

        .tab-button:hover {
            color: #2196F3;
        }

        .tab-button.active {
            color: #2196F3;
            border-bottom-color: #2196F3;
            font-weight: 600;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .events-info {
            margin-top: 8px;
            padding: 5px 10px;
            background: #f0f8ff;
            border-radius: 5px;
            border-left: 3px solid #2196F3;
        }

        .shift-result {
            transition: all 0.3s ease;
        }

        .shift-result:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .event-tooltip {
            position: absolute;
            background: rgba(44, 62, 80, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            line-height: 1.5;
            max-width: 300px;
            z-index: 2000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            display: none;
        }

        .event-tooltip h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #74c0fc;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 6px;
        }

        .event-tooltip .event-item {
            margin: 8px 0;
            padding: 6px;
            background: rgba(255,255,255,0.08);
            border-radius: 6px;
        }

        .event-tooltip .event-title {
            font-weight: bold;
            color: #ffd43b;
            margin-bottom: 4px;
        }

        .event-tooltip .event-time {
            color: #a5d8ff;
            font-size: 12px;
            margin-bottom: 3px;
        }

        .event-tooltip .event-location {
            color: #b2f2bb;
            font-size: 12px;
            margin-bottom: 3px;
        }

        .event-tooltip .event-description {
            color: #f8f9fa;
            font-size: 12px;
        }

        .event-tooltip .no-events {
            color: #adb5bd;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ æ±ç”¨ã‚·ãƒ•ãƒˆå¯èƒ½æ—¥è¨ˆç®—ã‚¢ãƒ—ãƒª</h1>
            <p>ã‚ã‚‰ã‚†ã‚‹å‹¤å‹™æ¡ä»¶ã«å¯¾å¿œã§ãã‚‹æŸ”è»Ÿãªã‚·ãƒ•ãƒˆè¨ˆç®—ãƒ„ãƒ¼ãƒ«</p>
        </div>

        <div class="content">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('settings-tab')">è¨­å®š</button>
                <button class="tab-button" onclick="showTab('results-tab')">çµæœ</button>
            </div>

            <div class="tab-content">
                <div id="settings-tab" class="tab-pane active">

            <!-- ç¾åœ¨ã®è¨­å®šè¡¨ç¤º -->
            <div class="current-settings" id="currentSettings">
                <h4>ğŸ“‹ ç¾åœ¨ã®è¨­å®š</h4>
                <div id="settingsDisplay"></div>
            </div>

            <!-- è¨­å®šãƒ‘ãƒãƒ« -->
            <div class="settings-grid">
                <!-- åŸºæœ¬è¨­å®š -->
                <div class="settings-panel">
                    <h3>â° åŸºæœ¬å‹¤å‹™æ¡ä»¶</h3>
                    
                    <div class="form-group">
                        <label class="tooltip" data-tooltip="ã‚·ãƒ•ãƒˆã§åƒãã“ã¨ãŒã§ãã‚‹æ™‚é–“å¸¯ã‚’è¨­å®šã—ã¾ã™ã€‚ã“ã®æ™‚é–“å¤–ã®äºˆå®šã¯è¨ˆç®—ã«å½±éŸ¿ã—ã¾ã›ã‚“ã€‚">
                            å–¶æ¥­æ™‚é–“ â“˜
                        </label>
                        <div class="time-range">
                            <input type="time" id="startTime" class="form-control form-control-small" value="10:00"
                                title="å‹¤å‹™é–‹å§‹å¯èƒ½ãªæ™‚åˆ»">
                            <span>ã€œ</span>
                            <input type="time" id="endTime" class="form-control form-control-small" value="18:00"
                                title="å‹¤å‹™çµ‚äº†æ™‚åˆ»">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="tooltip" data-tooltip="é€£ç¶šã—ã¦å‹¤å‹™ã§ãã‚‹æœ€ä½æ™‚é–“">
                            æœ€ä½å‹¤å‹™æ™‚é–“ â“˜
                        </label>
                        <div class="time-range">
                            <input type="number" id="minHours" class="form-control form-control-small" value="2" min="0.5" step="0.5">
                            <span>æ™‚é–“</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="tooltip" data-tooltip="äºˆå®šã®å‰å¾Œã«ç¢ºä¿ã™ã‚‹ç§»å‹•ãƒ»æº–å‚™æ™‚é–“">
                            ç§»å‹•æ™‚é–“ â“˜
                        </label>
                        <div class="time-range">
                            <input type="number" id="bufferTime" class="form-control form-control-small" value="30" min="0" step="15">
                            <span>åˆ†</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>é™¤å¤–ã™ã‚‹æ›œæ—¥</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude0" onchange="updateCheckboxUI(this)">
                                <label for="exclude0">æ—¥</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude1" onchange="updateCheckboxUI(this)">
                                <label for="exclude1">æœˆ</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude2" onchange="updateCheckboxUI(this)">
                                <label for="exclude2">ç«</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude3" onchange="updateCheckboxUI(this)">
                                <label for="exclude3">æ°´</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude4" onchange="updateCheckboxUI(this)">
                                <label for="exclude4">æœ¨</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude5" onchange="updateCheckboxUI(this)">
                                <label for="exclude5">é‡‘</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude6" onchange="updateCheckboxUI(this)">
                                <label for="exclude6">åœŸ</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æœŸé–“ãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨­å®š -->
                <div class="settings-panel">
                    <h3>ğŸ“… æœŸé–“ãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨­å®š</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDate" class="tooltip" data-tooltip="ã‚·ãƒ•ãƒˆè¨ˆç®—ã‚’è¡Œã†æœŸé–“ã®é–‹å§‹æ—¥ã‚’è¨­å®šã—ã¾ã™">
                                é–‹å§‹æ—¥ â“˜
                            </label>
                            <input type="date" id="startDate" class="form-control" required
                                title="ã‚·ãƒ•ãƒˆè¨ˆç®—é–‹å§‹æ—¥">
                        </div>
                        <div class="form-group">
                            <label for="endDate" class="tooltip" data-tooltip="ã‚·ãƒ•ãƒˆè¨ˆç®—ã‚’è¡Œã†æœŸé–“ã®çµ‚äº†æ—¥ã‚’è¨­å®šã—ã¾ã™">
                                çµ‚äº†æ—¥ â“˜
                            </label>
                            <input type="date" id="endDate" class="form-control" required
                                title="ã‚·ãƒ•ãƒˆè¨ˆç®—çµ‚äº†æ—¥">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="calendarId" class="tooltip" data-tooltip="Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ç‰¹å®šã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æŒ‡å®šã§ãã¾ã™ã€‚ã€Œprimaryã€ã¯ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ„å‘³ã—ã¾ã™ã€‚ä»–ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®è¨­å®šã‹ã‚‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼IDã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚">
                            ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ID â“˜
                        </label>
                        <input type="text" id="calendarId" class="form-control" placeholder="primary" value="primary"
                            title="ä½¿ç”¨ã™ã‚‹Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®IDï¼ˆprimary = ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‰">
                    </div>

                    <!-- é«˜åº¦ãªè¨­å®š -->
                    <div class="advanced-settings">
                        <h4>âš™ï¸ é«˜åº¦ãªè¨­å®š</h4>
                        
                        <div class="form-group">
                            <label class="tooltip" data-tooltip="ã“ã®æ™‚é–“æœªæº€ã®ç©ºãæ™‚é–“ã¯å‹¤å‹™ä¸å¯ã¨ã—ã¦æ‰±ã„ã¾ã™ã€‚çŸ­ã™ãã‚‹ç©ºãæ™‚é–“ã‚’é™¤å¤–ã§ãã¾ã™ã€‚">
                                æœ€å°ç©ºãæ™‚é–“ â“˜
                            </label>
                            <div class="time-range">
                                <input type="number" id="minGapTime" class="form-control form-control-small" value="30" min="0" step="15"
                                    title="å‹¤å‹™å¯èƒ½ã¨ã™ã‚‹æœ€å°ã®ç©ºãæ™‚é–“ï¼ˆåˆ†ï¼‰">
                                <span>åˆ†</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="tooltip" data-tooltip="1æ—¥ã‚ãŸã‚Šã®æœ€å¤§å‹¤å‹™æ™‚é–“ã§ã™ã€‚é•·æ™‚é–“ã®å‹¤å‹™ã‚’åˆ¶é™ã§ãã¾ã™ã€‚">
                                æœ€å¤§å‹¤å‹™æ™‚é–“ â“˜
                            </label>
                            <div class="time-range">
                                <input type="number" id="maxHours" class="form-control form-control-small" value="8" min="1" max="12" step="0.5"
                                    title="1æ—¥ã®æœ€å¤§å‹¤å‹™æ™‚é–“ï¼ˆæ™‚é–“ï¼‰">
                                <span>æ™‚é–“</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="allowSplitShifts" onchange="updateCheckboxUI(this)">
                                <label for="allowSplitShifts" class="tooltip" data-tooltip="1æ—¥ã«è¤‡æ•°ã®æ™‚é–“å¸¯ã§å‹¤å‹™å¯èƒ½">
                                    åˆ†å‰²ã‚·ãƒ•ãƒˆè¨±å¯ â“˜
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="excludeHolidays" onchange="updateCheckboxUI(this)">
                                <label for="excludeHolidays" class="tooltip" data-tooltip="æ—¥æœ¬ã®ç¥æ—¥ã‚’å‡ºå‹¤ä¸å¯ã«ã™ã‚‹">
                                    ç¥æ—¥ã‚’å‡ºå‹¤ä¸å¯ã«ã™ã‚‹ â“˜
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- èªè¨¼çŠ¶æ…‹è¡¨ç¤º -->
            <div id="authStatus" style="text-align: center; margin: 20px 0; padding: 15px; background: #e8f5e8; border-radius: 10px; border-left: 5px solid #4CAF50; display: none;">
                <span style="color: #2e7d32; font-weight: bold;">
                    âœ… Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼æ¸ˆã¿
                </span>
                <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #555;">
                    ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã®å–å¾—ãŒå¯èƒ½ã§ã™
                </p>
            </div>

            <!-- èªè¨¼ãƒ»å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
            <div style="text-align: center; margin: 30px 0;">
                <button class="btn btn-success" onclick="authenticateGoogle()" id="authButton" 
                    title="Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®èªè¨¼ã‚’è¡Œã„ã¾ã™">
                    ğŸ” Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼
                </button>
                <button class="btn" onclick="calculateShifts()" id="calculateButton" disabled
                    title="è¨­å®šã—ãŸæ¡ä»¶ã§ã‚·ãƒ•ãƒˆå¯èƒ½æ—¥ã‚’è¨ˆç®—ã—ã¾ã™">
                    ğŸ”„ ã‚·ãƒ•ãƒˆå¯èƒ½æ—¥ã‚’è¨ˆç®—
                </button>
                <button class="btn btn-secondary" onclick="saveSettings()"
                    title="ç¾åœ¨ã®è¨­å®šã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¾ã™">
                    ğŸ’¾ è¨­å®šã‚’ä¿å­˜
                </button>
                <button class="btn btn-secondary" onclick="loadSettings()"
                    title="ä¿å­˜ã—ãŸè¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã™">
                    ğŸ“‚ è¨­å®šã‚’èª­è¾¼
                </button>
            </div>
                </div>

                <div id="results-tab" class="tab-pane">
                    <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div id="resultsSection" class="results-section">
                        <div id="loadingDiv" class="loading">
                            <div class="spinner"></div>
                            <p>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã‚’å–å¾—ä¸­...</p>
                        </div>
                        
                        <div id="resultsContent" style="display: none;">
                            <h3>ğŸ“Š è¨ˆç®—çµæœ</h3>
                            <div id="summaryStats" class="summary-stats"></div>
                            <div id="shiftResults"></div>
                            
                            <div style="text-align: center; margin-top: 30px;">
                                <button class="btn btn-success" onclick="exportToPDF()">
                                    ğŸ“„ PDFå‡ºåŠ›
                                </button>
                                <button class="btn btn-secondary" onclick="exportToCSV()">
                                    ğŸ“Š CSVå‡ºåŠ›
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Googleèªè¨¼
        function authenticateGoogle() {
            window.location.href = '/auth/google/login';
        }

        // èªè¨¼çŠ¶æ…‹ç¢ºèªï¼ˆã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã¨APIå¤±æ•—æ™‚ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ï¼‰
        async function checkAuthStatus() {
            console.log('èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªä¸­...');
            
            const authButton = document.getElementById('authButton');
            const calculateButton = document.getElementById('calculateButton');
            const authStatus = document.getElementById('authStatus');
            
            // åˆæœŸçŠ¶æ…‹ï¼šèªè¨¼çŠ¶æ…‹ä¸æ˜
            authStatus.style.display = 'none';
            authButton.style.display = 'inline-flex';
            calculateButton.disabled = true;
            
            try {
                // å®Ÿéš›ã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼APIã‚’å‘¼ã³å‡ºã—ã¦èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
                const testDate = new Date().toISOString().split('T')[0];
                const response = await fetch(`/api/calendar/events?startDate=${testDate}&endDate=${testDate}&calendarId=primary`);
                
                console.log('APIå¿œç­”ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                
                if (response.ok) {
                    // èªè¨¼æ¸ˆã¿ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ
                    const data = await response.json();
                    console.log('èªè¨¼æˆåŠŸï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†', data.length + 'ä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆ');
                    
                    authButton.style.display = 'none';
                    calculateButton.disabled = false;
                    authStatus.style.display = 'block';
                    
                    return true;
                } else if (response.status === 401) {
                    // æœªèªè¨¼
                    console.log('æœªèªè¨¼ï¼šèªè¨¼ãŒå¿…è¦ã§ã™');
                    
                    authButton.style.display = 'inline-flex';
                    authButton.textContent = 'ğŸ” Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆèªè¨¼';
                    calculateButton.disabled = true;
                    authStatus.style.display = 'none';
                    
                    return false;
                } else {
                    // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
                    console.log('API ã‚¨ãƒ©ãƒ¼:', response.status);
                    const errorData = await response.json().catch(() => ({}));
                    console.log('ã‚¨ãƒ©ãƒ¼è©³ç´°:', errorData);
                    
                    authButton.style.display = 'inline-flex';
                    authButton.textContent = 'ğŸ” å†èªè¨¼ãŒå¿…è¦';
                    calculateButton.disabled = true;
                    authStatus.style.display = 'none';
                    
                    return false;
                }
            } catch (error) {
                console.error('èªè¨¼çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                
                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãªã©ã®å ´åˆ
                authButton.style.display = 'inline-flex';
                authButton.textContent = 'ğŸ” èªè¨¼çŠ¶æ…‹ç¢ºèªå¤±æ•—';
                calculateButton.disabled = true;
                authStatus.style.display = 'none';
                
                return false;
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            
            // 2é€±é–“å¾Œã‚’çµ‚äº†æ—¥ã«è¨­å®š
            const twoWeeksLater = new Date();
            twoWeeksLater.setDate(twoWeeksLater.getDate() + 14);
            document.getElementById('endDate').value = twoWeeksLater.toISOString().split('T')[0];

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ°´æ›œã¨æ—¥æ›œã‚’é™¤å¤–
            document.getElementById('exclude0').checked = true;
            document.getElementById('exclude3').checked = true;
            updateAllCheckboxUI();
            
            updateSettingsDisplay();
            
            // è¨­å®šå¤‰æ›´æ™‚ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
            document.addEventListener('input', updateSettingsDisplay);
            document.addEventListener('change', updateSettingsDisplay);

            // åˆæœŸè¡¨ç¤ºã¯è¨­å®šã‚¿ãƒ–
            showTab('settings-tab');

            // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«èªè¨¼çŠ¶æ…‹ã‚’è‡ªå‹•ç¢ºèª
            console.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ï¼šèªè¨¼çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã™');
            checkAuthStatus();
        });

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function showTab(tabId) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤ºã«ã—ã€activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // æŒ‡å®šã•ã‚ŒãŸã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºã—ã€activeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');

            // çµæœã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ã‚ã£ãŸéš›ã«resultsSectionã‚’è¡¨ç¤º
            if (tabId === 'results-tab') {
                document.getElementById('resultsSection').classList.add('show');
            } else {
                document.getElementById('resultsSection').classList.remove('show');
            }
        }

        // è¨­å®šãƒªã‚»ãƒƒãƒˆ
        function resetSettings() {
            document.getElementById('startTime').value = '09:00';
            document.getElementById('endTime').value = '17:00';
            document.getElementById('minHours').value = '2';
            document.getElementById('bufferTime').value = '30';
            document.getElementById('maxHours').value = '8';
            document.getElementById('minGapTime').value = '30';
            document.getElementById('allowSplitShifts').checked = false;
            document.getElementById('excludeHolidays').checked = false;

            for (let i = 0; i < 7; i++) {
                document.getElementById(`exclude${i}`).checked = false;
            }

            updateAllCheckboxUI();
            updateSettingsDisplay();
        }

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®UIæ›´æ–°
        function updateCheckboxUI(checkbox) {
            const item = checkbox.closest('.checkbox-item');
            if (checkbox.checked) {
                item.classList.add('checked');
            } else {
                item.classList.remove('checked');
            }
        }

        function updateAllCheckboxUI() {
            for (let i = 0; i < 7; i++) {
                updateCheckboxUI(document.getElementById(`exclude${i}`));
            }
            updateCheckboxUI(document.getElementById('allowSplitShifts'));
            updateCheckboxUI(document.getElementById('excludeHolidays'));
        }

        // ç¾åœ¨ã®è¨­å®šè¡¨ç¤ºã‚’æ›´æ–°
        function updateSettingsDisplay() {
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const minHours = document.getElementById('minHours').value;
            const bufferTime = document.getElementById('bufferTime').value;
            const maxHours = document.getElementById('maxHours').value;
            const minGapTime = document.getElementById('minGapTime').value;
            const allowSplitShifts = document.getElementById('allowSplitShifts').checked;
            const excludeHolidays = document.getElementById('excludeHolidays').checked;

            const excludedDays = [];
            const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            for (let i = 0; i < 7; i++) {
                if (document.getElementById(`exclude${i}`).checked) {
                    excludedDays.push(dayNames[i]);
                }
            }

            const displayHTML = `
                <span class="setting-item">â° ${startTime}ã€œ${endTime}</span>
                <span class="setting-item">â±ï¸ æœ€ä½${minHours}æ™‚é–“</span>
                <span class="setting-item">ğŸš¶ ç§»å‹•${bufferTime}åˆ†</span>
                <span class="setting-item">ğŸ“Š æœ€å¤§${maxHours}æ™‚é–“</span>
                <span class="setting-item">âš¡ æœ€å°ç©ºã${minGapTime}åˆ†</span>
                ${excludedDays.length > 0 ? `<span class="setting-item">ğŸš« ${excludedDays.join('ãƒ»')}æ›œæ—¥é™¤å¤–</span>` : ''}
                ${allowSplitShifts ? '<span class="setting-item">âœ‚ï¸ åˆ†å‰²ã‚·ãƒ•ãƒˆå¯</span>' : ''}
                ${excludeHolidays ? '<span class="setting-item">ğŸŒ ç¥æ—¥é™¤å¤–</span>' : ''}
            `;

            document.getElementById('settingsDisplay').innerHTML = displayHTML;
        }

        // è¨­å®šã®ä¿å­˜
        function saveSettings() {
            const settings = {
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                minHours: document.getElementById('minHours').value,
                bufferTime: document.getElementById('bufferTime').value,
                maxHours: document.getElementById('maxHours').value,
                minGapTime: document.getElementById('minGapTime').value,
                allowSplitShifts: document.getElementById('allowSplitShifts').checked,
                excludeHolidays: document.getElementById('excludeHolidays').checked,
                excludedDays: []
            };

            for (let i = 0; i < 7; i++) {
                if (document.getElementById(`exclude${i}`).checked) {
                    settings.excludedDays.push(i);
                }
            }

            localStorage.setItem('shiftCalculatorSettings', JSON.stringify(settings));
            alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        }

        // è¨­å®šã®èª­ã¿è¾¼ã¿
        function loadSettings() {
            const saved = localStorage.getItem('shiftCalculatorSettings');
            if (!saved) {
                alert('ä¿å­˜ã•ã‚ŒãŸè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            const settings = JSON.parse(saved);
            
            document.getElementById('startTime').value = settings.startTime;
            document.getElementById('endTime').value = settings.endTime;
            document.getElementById('minHours').value = settings.minHours;
            document.getElementById('bufferTime').value = settings.bufferTime;
            document.getElementById('maxHours').value = settings.maxHours;
            document.getElementById('minGapTime').value = settings.minGapTime;
            document.getElementById('allowSplitShifts').checked = settings.allowSplitShifts;
            document.getElementById('excludeHolidays').checked = settings.excludeHolidays;

            for (let i = 0; i < 7; i++) {
                document.getElementById(`exclude${i}`).checked = settings.excludedDays.includes(i);
            }

            updateAllCheckboxUI();
            updateSettingsDisplay();
            alert('è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼');
        }

        // ç¾åœ¨ã®è¨­å®šã‚’å–å¾—
        function getCurrentSettings() {
            const excludedDays = [];
            for (let i = 0; i < 7; i++) {
                if (document.getElementById(`exclude${i}`).checked) {
                    excludedDays.push(i);
                }
            }

            return {
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                minHours: parseFloat(document.getElementById('minHours').value),
                bufferTime: parseInt(document.getElementById('bufferTime').value),
                maxHours: parseFloat(document.getElementById('maxHours').value),
                minGapTime: parseInt(document.getElementById('minGapTime').value),
                allowSplitShifts: document.getElementById('allowSplitShifts').checked,
                excludeHolidays: document.getElementById('excludeHolidays').checked,
                excludedDays: excludedDays
            };
        }

        // ã‚·ãƒ•ãƒˆè¨ˆç®—ã®ãƒ¡ã‚¤ãƒ³é–¢æ•°
        async function calculateShifts() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const calendarId = document.getElementById('calendarId').value || 'primary';
            const settings = getCurrentSettings();

            if (!startDate || !endDate) {
                alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // çµæœã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
            showTab('results-tab');
            
            // çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.add('show');
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            document.getElementById('loadingDiv').style.display = 'block';
            document.getElementById('resultsContent').style.display = 'none';

            try {
                // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã‚’å–å¾—
                await fetchCalendarDataFromBackend(startDate, endDate, calendarId, settings);
            } catch (error) {
                console.error('ã‚¨ãƒ©ãƒ¼:', error);
                
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯èªè¨¼çŠ¶æ…‹ã‚’å†ç¢ºèªã—ã¦é©åˆ‡ãªUIã‚’è¡¨ç¤º
                const isAuthenticated = await checkAuthStatus();
                if (!isAuthenticated) {
                    alert('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚èªè¨¼ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§èªè¨¼ã—ã¦ãã ã•ã„ã€‚');
                } else {
                    alert('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
                }
                document.getElementById('loadingDiv').style.display = 'none';
            }
        }

        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã‚’å–å¾—
        async function fetchCalendarDataFromBackend(startDate, endDate, calendarId, settings) {
            try {
                // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã‚’å‘¼ã³å‡ºã—ã¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
                const response = await fetch(`/api/calendar/events?startDate=${startDate}&endDate=${endDate}&calendarId=${calendarId}`);
                
                if (response.status === 401) {
                    // èªè¨¼ãŒå¿…è¦ãªå ´åˆï¼šèªè¨¼çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¦ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                    console.log('èªè¨¼ã‚¨ãƒ©ãƒ¼ï¼šèªè¨¼çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã™');
                    await checkAuthStatus(); // èªè¨¼çŠ¶æ…‹ã‚’æ›´æ–°
                    
                    alert('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã®èªè¨¼ãŒå¿…è¦ã§ã™ã€‚');
                    document.getElementById('loadingDiv').style.display = 'none';
                    return;
                }
                
                if (!response.ok) {
                    // ãã®ä»–ã®APIã‚¨ãƒ©ãƒ¼
                    console.log('APIã‚¨ãƒ©ãƒ¼:', response.status);
                    const errorData = await response.json().catch(() => ({}));
                    console.log('ã‚¨ãƒ©ãƒ¼è©³ç´°:', errorData);
                    
                    // èªè¨¼çŠ¶æ…‹ã‚’å†ç¢ºèª
                    await checkAuthStatus();
                    
                    throw new Error(`ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼API error! status: ${response.status}, message: ${errorData.error || 'Unknown error'}`);
                }
                
                const events = await response.json();
                console.log('å–å¾—ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆ:', events);
                
                // å–å¾—ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½¿ã£ã¦ã‚·ãƒ•ãƒˆã‚’è¨ˆç®—
                await calculateShiftsWithRealData(startDate, endDate, events, settings);
                
            } catch (error) {
                console.error('ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
                
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯èªè¨¼çŠ¶æ…‹ã‚’å†ç¢ºèª
                await checkAuthStatus();
                throw error;
            }
        }

        // å®Ÿéš›ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ãŸã‚·ãƒ•ãƒˆè¨ˆç®—
        async function calculateShiftsWithRealData(startDate, endDate, events, settings) {
            let holidays = {};
            if (settings.excludeHolidays) {
                try {
                    const startYear = new Date(startDate).getFullYear();
                    const endYear = new Date(endDate).getFullYear();
                    for (let year = startYear; year <= endYear; year++) {
                        const response = await fetch(`https://holidays-jp.github.io/api/v1/${year}/date.json`);
                        if (response.ok) {
                            const yearHolidays = await response.json();
                            holidays = { ...holidays, ...yearHolidays };
                        }
                    }
                } catch (error) {
                    console.error("Error fetching holidays:", error);
                }
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆè¨ˆç®—ç”¨ã¨è¡¨ç¤ºç”¨ã‚’åˆ†é›¢ï¼‰
            const eventsByDate = {}; // æ™‚é–“æŒ‡å®šã®ã‚ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè¨ˆç®—ç”¨ï¼‰
            const allDayEventsByDate = {}; // çµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè¡¨ç¤ºå°‚ç”¨ï¼‰
            
            events.forEach(event => {
                // çµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
                if (event.start.includes('T') && event.end.includes('T')) {
                    // æ™‚é–“æŒ‡å®šã®ã‚ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè¨ˆç®—ã«ä½¿ç”¨ï¼‰
                    const eventDate = event.start.split('T')[0];
                    if (!eventsByDate[eventDate]) {
                        eventsByDate[eventDate] = [];
                    }
                    eventsByDate[eventDate].push({
                        start: event.start.split('T')[1].substring(0, 5),
                        end: event.end.split('T')[1].substring(0, 5),
                        summary: event.summary,
                        location: event.location,
                        description: event.description,
                        isAllDay: false
                    });
                } else {
                    // çµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè¡¨ç¤ºã®ã¿ï¼‰- è¤‡æ•°æ—¥å¯¾å¿œ
                    const startDate = new Date(event.start);
                    const endDate = new Date(event.end);
                    
                    // çµ‚äº†æ—¥ã‹ã‚‰1æ—¥å¼•ãï¼ˆGoogleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®çµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆã¯ç¿Œæ—¥ã®00:00ãŒçµ‚äº†æ™‚åˆ»ï¼‰
                    endDate.setDate(endDate.getDate() - 1);
                    
                    // é–‹å§‹æ—¥ã‹ã‚‰çµ‚äº†æ—¥ã¾ã§å„æ—¥ã«è¿½åŠ 
                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        const dateStr = d.toISOString().split('T')[0];
                        
                        if (!allDayEventsByDate[dateStr]) {
                            allDayEventsByDate[dateStr] = [];
                        }
                        
                        // è¤‡æ•°æ—¥ã®å ´åˆã¯æ—¥æ•°æƒ…å ±ã‚’è¿½åŠ 
                        const isMultiDay = startDate.getTime() !== endDate.getTime();
                        const dayInfo = isMultiDay ? 
                            ` (${startDate.toLocaleDateString('ja-JP', {month: 'short', day: 'numeric'})}ã€œ${endDate.toLocaleDateString('ja-JP', {month: 'short', day: 'numeric'})})` : '';
                        
                        allDayEventsByDate[dateStr].push({
                            start: 'çµ‚æ—¥',
                            end: 'çµ‚æ—¥',
                            summary: event.summary + dayInfo,
                            originalSummary: event.summary,
                            location: event.location,
                            description: event.description,
                            isAllDay: true,
                            isMultiDay: isMultiDay,
                            eventStartDate: startDate.toISOString().split('T')[0],
                            eventEndDate: endDate.toISOString().split('T')[0],
                            currentDate: dateStr
                        });
                    }
                }
            });

            // è¨­å®šã«åŸºã¥ã„ã¦ã‚·ãƒ•ãƒˆã‚’è¨ˆç®—
            const shifts = calculateShiftsWithRealEvents(startDate, endDate, eventsByDate, allDayEventsByDate, settings, holidays);
            displayResults(shifts, settings);
        }

        // å®Ÿéš›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ãŸã‚·ãƒ•ãƒˆè¨ˆç®—
        function calculateShiftsWithRealEvents(startDate, endDate, eventsByDate, allDayEventsByDate, settings, holidays) {
            const shifts = [];
            const start = new Date(startDate);
            const end = new Date(endDate);

            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                const dayOfWeek = date.getDay();
                const dateStr = date.toISOString().split('T')[0];
                const dayName = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][dayOfWeek];

                // é™¤å¤–æ›œæ—¥ãƒã‚§ãƒƒã‚¯
                if (settings.excludedDays.includes(dayOfWeek)) {
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'excluded',
                        reason: `${dayName}æ›œæ—¥ã®ãŸã‚å¯¾è±¡å¤–`,
                        availableTime: null,
                        duration: 0,
                        shifts: [],
                        events: [...(eventsByDate[dateStr] || []), ...(allDayEventsByDate[dateStr] || [])],
                        selected: false
                    });
                    continue;
                }

                // ç¥æ—¥é™¤å¤–ãƒã‚§ãƒƒã‚¯
                if (settings.excludeHolidays && holidays[dateStr]) {
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'excluded',
                        reason: `ç¥æ—¥ï¼ˆ${holidays[dateStr]}ï¼‰ã®ãŸã‚å¯¾è±¡å¤–`,
                        availableTime: null,
                        duration: 0,
                        shifts: [],
                        events: [...(eventsByDate[dateStr] || []), ...(allDayEventsByDate[dateStr] || [])],
                        selected: false
                    });
                    continue;
                }

                // ãã®æ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ï¼ˆè¨ˆç®—ç”¨ï¼šæ™‚é–“æŒ‡å®šã®ã¿ï¼‰
                const dayEvents = eventsByDate[dateStr] || [];
                
                // ãã®æ—¥ã®çµ‚æ—¥ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—ï¼ˆè¡¨ç¤ºç”¨ï¼‰
                const allDayEvents = allDayEventsByDate[dateStr] || [];
                
                // è¡¨ç¤ºç”¨ã«å…¨ã‚¤ãƒ™ãƒ³ãƒˆã‚’çµåˆ
                const allEventsForDisplay = [...dayEvents, ...allDayEvents];
                
                // å–¶æ¥­æ™‚é–“å†…ã®åˆ©ç”¨å¯èƒ½æ™‚é–“ã‚’è¨ˆç®—
                const availableSlots = calculateAvailableSlots(
                    settings.startTime,
                    settings.endTime,
                    dayEvents,
                    settings
                );

                // åˆ©ç”¨å¯èƒ½ã‚¹ãƒ­ãƒƒãƒˆï¼ˆæ—¢ã«æœ€ä½å‹¤å‹™æ™‚é–“ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ï¼‰
                const validSlots = availableSlots;

                if (validSlots.length > 0) {
                    const totalDuration = validSlots.reduce((sum, slot) => sum + slot.duration, 0);
                    const maxDuration = Math.min(totalDuration, settings.maxHours);

                    if (settings.allowSplitShifts && validSlots.length > 1) {
                        shifts.push({
                            date: dateStr,
                            dayName: dayName,
                            status: 'available',
                            reason: 'è¤‡æ•°æ™‚é–“å¸¯ã§å‹¤å‹™å¯èƒ½',
                            availableTime: validSlots.map(slot => `${slot.start}-${slot.end}`).join(', '),
                            duration: maxDuration,
                            shifts: validSlots,
                            events: allEventsForDisplay,
                            selected: true  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é¸æŠçŠ¶æ…‹
                        });
                    } else {
                        const bestSlot = validSlots[0];
                        const adjustedEnd = maxDuration < bestSlot.duration ? 
                            addHours(bestSlot.start, maxDuration) : bestSlot.end;
                        
                        shifts.push({
                            date: dateStr,
                            dayName: dayName,
                            status: 'available',
                            reason: 'å‹¤å‹™å¯èƒ½',
                            availableTime: `${bestSlot.start}-${adjustedEnd}`,
                            duration: Math.min(bestSlot.duration, maxDuration),
                            shifts: [{ start: bestSlot.start, end: adjustedEnd, duration: Math.min(bestSlot.duration, maxDuration) }],
                            events: allEventsForDisplay,
                            selected: true  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é¸æŠçŠ¶æ…‹
                        });
                    }
                } else {
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'unavailable',
                        reason: dayEvents.length > 0 ? 'äºˆå®šã«ã‚ˆã‚Šæœ€ä½å‹¤å‹™æ™‚é–“ç¢ºä¿ä¸å¯' : 'å‹¤å‹™æ™‚é–“ç¢ºä¿ä¸å¯',
                        availableTime: null,
                        duration: 0,
                        shifts: [],
                        events: dayEvents,
                        selected: false
                    });
                }
            }

            return shifts;
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å–å¾—ã¨ã‚·ãƒ•ãƒˆè¨ˆç®—ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
        async function simulateCalendarFetch(startDate, endDate, calendarId, settings) {
            await new Promise(resolve => setTimeout(resolve, 2000));

            let holidays = {};
            if (settings.excludeHolidays) {
                try {
                    const startYear = new Date(startDate).getFullYear();
                    const endYear = new Date(endDate).getFullYear();
                    for (let year = startYear; year <= endYear; year++) {
                        const response = await fetch(`https://holidays-jp.github.io/api/v1/${year}/date.json`);
                        if (!response.ok) {
                            throw new Error(`Failed to fetch holidays for ${year}: ${response.statusText}`);
                        }
                        const yearHolidays = await response.json();
                        holidays = { ...holidays, ...yearHolidays };
                    }
                    console.log("Fetched holidays:", holidays);
                } catch (error) {
                    console.error("Error fetching holidays:", error);
                    alert("ç¥æ—¥æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç¥æ—¥é™¤å¤–è¨­å®šã¯é©ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚");
                }
            }

            // è¨­å®šã«åŸºã¥ã„ã¦ã‚·ãƒ•ãƒˆã‚’è¨ˆç®—
            const shifts = calculateShiftsWithSettings(startDate, endDate, settings, holidays);
            displayResults(shifts, settings);
        }

        // è¨­å®šã«åŸºã¥ãã‚·ãƒ•ãƒˆè¨ˆç®—
        function calculateShiftsWithSettings(startDate, endDate, settings, holidays) {
            const shifts = [];
            const start = new Date(startDate);
            const end = new Date(endDate);

            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                const dayOfWeek = date.getDay();
                const dateStr = date.toISOString().split('T')[0];
                const dayName = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][dayOfWeek];

                // é™¤å¤–æ›œæ—¥ãƒã‚§ãƒƒã‚¯
                if (settings.excludedDays.includes(dayOfWeek)) {
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'excluded',
                        reason: `${dayName}æ›œæ—¥ã®ãŸã‚å¯¾è±¡å¤–`,
                        availableTime: null,
                        duration: 0,
                        shifts: [],
                        events: [...(eventsByDate[dateStr] || []), ...(allDayEventsByDate[dateStr] || [])],
                        selected: false
                    });
                    continue;
                }

                // ç¥æ—¥é™¤å¤–ãƒã‚§ãƒƒã‚¯
                if (settings.excludeHolidays && holidays[dateStr]) {
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'excluded',
                        reason: `ç¥æ—¥ï¼ˆ${holidays[dateStr]}ï¼‰ã®ãŸã‚å¯¾è±¡å¤–`,
                        availableTime: null,
                        duration: 0,
                        shifts: [],
                        events: [...(eventsByDate[dateStr] || []), ...(allDayEventsByDate[dateStr] || [])],
                        selected: false
                    });
                    continue;
                }

                // ãƒ©ãƒ³ãƒ€ãƒ ã«äºˆå®šã‚’ç”Ÿæˆï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
                const hasEvent = Math.random() < 0.4; // 40%ã®ç¢ºç‡ã§äºˆå®šã‚ã‚Š
                let availableSlots = [];

                if (hasEvent) {
                    // äºˆå®šãŒã‚ã‚‹å ´åˆã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                    const eventStart = randomTime(settings.startTime, settings.endTime);
                    const eventDuration = Math.random() * 4 + 1; // 1-5æ™‚é–“ã®äºˆå®š
                    const eventEnd = addHours(eventStart, eventDuration);

                    // å–¶æ¥­æ™‚é–“å†…ã®åˆ©ç”¨å¯èƒ½æ™‚é–“ã‚’è¨ˆç®—
                    availableSlots = calculateAvailableSlots(
                        settings.startTime,
                        settings.endTime,
                        [{start: eventStart, end: eventEnd}],
                        settings
                    );
                } else {
                    // äºˆå®šãŒãªã„å ´åˆã¯å…¨æ™‚é–“åˆ©ç”¨å¯èƒ½
                    availableSlots = [{
                        start: settings.startTime,
                        end: settings.endTime,
                        duration: calculateDuration(settings.startTime, settings.endTime)
                    }];
                }

                // æœ€ä½å‹¤å‹™æ™‚é–“ã‚’æº€ãŸã™ã‚¹ãƒ­ãƒƒãƒˆã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const validSlots = availableSlots.filter(slot => slot.duration >= settings.minHours);

                if (validSlots.length > 0) {
                    const totalDuration = validSlots.reduce((sum, slot) => sum + slot.duration, 0);
                    const maxDuration = Math.min(totalDuration, settings.maxHours);

                    if (settings.allowSplitShifts && validSlots.length > 1) {
                        shifts.push({
                            date: dateStr,
                            dayName: dayName,
                            status: 'available',
                            reason: 'è¤‡æ•°æ™‚é–“å¸¯ã§å‹¤å‹™å¯èƒ½',
                            availableTime: validSlots.map(slot => `${slot.start}-${slot.end}`).join(', '),
                            duration: maxDuration,
                            shifts: validSlots,
                            events: allEventsForDisplay,
                            selected: true  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é¸æŠçŠ¶æ…‹
                        });
                    } else {
                        const bestSlot = validSlots[0];
                        const adjustedEnd = maxDuration < bestSlot.duration ? 
                            addHours(bestSlot.start, maxDuration) : bestSlot.end;
                        
                        shifts.push({
                            date: dateStr,
                            dayName: dayName,
                            status: 'available',
                            reason: 'å‹¤å‹™å¯èƒ½',
                            availableTime: `${bestSlot.start}-${adjustedEnd}`,
                            duration: Math.min(bestSlot.duration, maxDuration),
                            shifts: [{ start: bestSlot.start, end: adjustedEnd, duration: Math.min(bestSlot.duration, maxDuration) }],
                            events: allEventsForDisplay,
                            selected: true  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é¸æŠçŠ¶æ…‹
                        });
                    }
                } else {
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'unavailable',
                        reason: hasEvent ? 'äºˆå®šã«ã‚ˆã‚Šæœ€ä½å‹¤å‹™æ™‚é–“ç¢ºä¿ä¸å¯' : 'å‹¤å‹™æ™‚é–“ç¢ºä¿ä¸å¯',
                        availableTime: null,
                        duration: 0,
                        shifts: []
                    });
                }
            }

            return shifts;
        }

        // åˆ©ç”¨å¯èƒ½æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆè¨ˆç®—
        function calculateAvailableSlots(startTime, endTime, events, settings) {
            const slots = [];
            const workStart = timeToMinutes(startTime);
            const workEnd = timeToMinutes(endTime);

            // ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ™‚é–“é †ã«ã‚½ãƒ¼ãƒˆ
            events.sort((a, b) => timeToMinutes(a.start) - timeToMinutes(b.start));

            let currentStart = workStart;

            for (const event of events) {
                // ã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚é–“ã‚’åˆ†ã«å¤‰æ›ã—ã€ç§»å‹•æ™‚é–“ã‚’è€ƒæ…®
                const eventStartMinutes = timeToMinutes(event.start);
                const eventEndMinutes = timeToMinutes(event.end);
                
                // å–¶æ¥­æ™‚é–“å¤–ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ç„¡è¦–
                if (eventEndMinutes <= workStart || eventStartMinutes >= workEnd) {
                    continue;
                }
                
                // ç§»å‹•æ™‚é–“ã‚’è€ƒæ…®ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã®é–‹å§‹ãƒ»çµ‚äº†æ™‚é–“
                const blockedStart = Math.max(workStart, eventStartMinutes - settings.bufferTime);
                const blockedEnd = Math.min(workEnd, eventEndMinutes + settings.bufferTime);

                // ç¾åœ¨ä½ç½®ã‹ã‚‰ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸé–‹å§‹æ™‚é–“ã¾ã§ã«åˆ©ç”¨å¯èƒ½ãªæ™‚é–“ãŒã‚ã‚‹ã‹
                if (currentStart < blockedStart) {
                    const slotDuration = (blockedStart - currentStart) / 60;
                    // æœ€å°ç©ºãæ™‚é–“ã¨æœ€ä½å‹¤å‹™æ™‚é–“ã®ä¸¡æ–¹ã‚’ãƒã‚§ãƒƒã‚¯
                    if (slotDuration >= Math.max(settings.minGapTime / 60, settings.minHours)) {
                        slots.push({
                            start: minutesToTime(currentStart),
                            end: minutesToTime(blockedStart),
                            duration: slotDuration
                        });
                    }
                }

                // æ¬¡ã®é–‹å§‹å¯èƒ½æ™‚é–“ã‚’æ›´æ–°
                currentStart = Math.max(currentStart, blockedEnd);
            }

            // æœ€å¾Œã®ã‚¹ãƒ­ãƒƒãƒˆï¼ˆæœ€å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆå¾Œã‹ã‚‰å–¶æ¥­æ™‚é–“çµ‚äº†ã¾ã§ï¼‰
            if (currentStart < workEnd) {
                const slotDuration = (workEnd - currentStart) / 60;
                // æœ€å°ç©ºãæ™‚é–“ã¨æœ€ä½å‹¤å‹™æ™‚é–“ã®ä¸¡æ–¹ã‚’ãƒã‚§ãƒƒã‚¯
                if (slotDuration >= Math.max(settings.minGapTime / 60, settings.minHours)) {
                    slots.push({
                        start: minutesToTime(currentStart),
                        end: minutesToTime(workEnd),
                        duration: slotDuration
                    });
                }
            }

            return slots;
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        function calculateDuration(startTime, endTime) {
            return (timeToMinutes(endTime) - timeToMinutes(startTime)) / 60;
        }

        function addHours(timeStr, hours) {
            const startMinutes = timeToMinutes(timeStr);
            const endMinutes = startMinutes + (hours * 60);
            return minutesToTime(Math.round(endMinutes));
        }

        function randomTime(startTime, endTime) {
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = timeToMinutes(endTime);
            const randomMinutes = startMinutes + Math.random() * (endMinutes - startMinutes);
            return minutesToTime(Math.round(randomMinutes));
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        let globalShifts = [];

        // çµæœè¡¨ç¤º
        function displayResults(shifts, settings) {
            globalShifts = shifts; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('resultsContent').style.display = 'block';

            // çµ±è¨ˆè¨ˆç®—
            const availableShifts = shifts.filter(s => s.status === 'available');
            const partialShifts = shifts.filter(s => s.status === 'partial');
            const unavailableShifts = shifts.filter(s => s.status === 'unavailable');
            const excludedShifts = shifts.filter(s => s.status === 'excluded');
            const selectedShifts = availableShifts.filter(s => s.selected);
            const totalHours = availableShifts.reduce((sum, s) => sum + s.duration, 0);
            const selectedHours = selectedShifts.reduce((sum, s) => sum + s.duration, 0);
            const avgHoursPerDay = availableShifts.length > 0 ? (totalHours / availableShifts.length) : 0;

            // çµ±è¨ˆè¡¨ç¤º
            const statsHtml = `
                <div class="stat-card">
                    <span class="stat-number">${availableShifts.length}</span>
                    <div class="stat-label">å‡ºå‹¤å¯èƒ½æ—¥</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" style="color: #4CAF50;">${selectedShifts.length}</span>
                    <div class="stat-label">é¸æŠæ¸ˆã¿å‡ºå‹¤æ—¥</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${totalHours.toFixed(1)}</span>
                    <div class="stat-label">åˆè¨ˆå‹¤å‹™æ™‚é–“</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" style="color: #4CAF50;">${selectedHours.toFixed(1)}</span>
                    <div class="stat-label">é¸æŠæ¸ˆã¿å‹¤å‹™æ™‚é–“</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${unavailableShifts.length + excludedShifts.length}</span>
                    <div class="stat-label">å‡ºå‹¤ä¸å¯ãƒ»é™¤å¤–æ—¥</div>
                </div>
            `;
            document.getElementById('summaryStats').innerHTML = statsHtml;

            // è©³ç´°ãªçµæœè¡¨ç¤º
            displayDetailedResults(shifts);
            
            // é¸æŠæ©Ÿèƒ½ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            displaySelectionControls();
            
            // ã‚·ãƒ•ãƒˆè¡¨ç”Ÿæˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            displayShiftTableButton();
        }

        // è©³ç´°ãªçµæœè¡¨ç¤º
        function displayDetailedResults(shifts) {
            const resultsHtml = shifts.map((shift, index) => {
                const statusClass = shift.status === 'excluded' ? 'unavailable' : shift.status;
                const statusIcon = {
                    'available': 'âœ…',
                    'partial': 'âš ï¸',
                    'unavailable': 'âŒ',
                    'excluded': 'ğŸš«'
                }[shift.status];

                // ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã®è¡¨ç¤ºï¼ˆçµ‚æ—¥äºˆå®šã¨æ™‚é–“æŒ‡å®šäºˆå®šã‚’åˆ†ã‘ã¦è¡¨ç¤ºï¼‰
                let eventsDisplay = '';
                if (shift.events && shift.events.length > 0) {
                    const timeBasedEvents = shift.events.filter(event => !event.isAllDay);
                    const allDayEvents = shift.events.filter(event => event.isAllDay);
                    
                    let eventTexts = [];
                    
                    // æ™‚é–“æŒ‡å®šã®äºˆå®š
                    if (timeBasedEvents.length > 0) {
                        eventTexts.push(`â° æ™‚é–“æŒ‡å®š: ${timeBasedEvents.map(event => 
                            `${event.summary} (${event.start}-${event.end})`
                        ).join(', ')}`);
                    }
                    
                    // çµ‚æ—¥äºˆå®š
                    if (allDayEvents.length > 0) {
                        eventTexts.push(`ğŸ“… çµ‚æ—¥ã®äºˆå®š: ${allDayEvents.map(event => 
                            event.summary
                        ).join(', ')}`);
                    }
                    
                    if (eventTexts.length > 0) {
                        eventsDisplay = `<div class="events-info">
                            <small>${eventTexts.join(' | ')}</small>
                        </div>`;
                    }
                }

                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆå‡ºå‹¤å¯èƒ½æ—¥ã®ã¿ï¼‰
                const checkbox = shift.status === 'available' ? 
                    `<input type="checkbox" id="shift-${index}" ${shift.selected ? 'checked' : ''} 
                     onchange="toggleShiftSelection(${index})" style="margin-right: 10px;">` : '';

                // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ç”¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’æº–å‚™
                const tooltipData = shift.events ? JSON.stringify(shift.events).replace(/"/g, '&quot;') : '[]';

                const timeDisplay = shift.availableTime ? 
                    `<span class="time-badge ${statusClass}">${shift.availableTime} (${shift.duration.toFixed(1)}h)</span>` :
                    `<span class="time-badge unavailable">${shift.reason}</span>`;

                return `
                    <div class="shift-result ${statusClass}" id="shift-row-${index}" 
                         data-events='${tooltipData}'
                         onmouseenter="showEventTooltip(event, ${index})" 
                         onmouseleave="hideEventTooltip()">
                        <div class="date-info">
                            ${checkbox}${statusIcon} ${shift.date} (${shift.dayName})
                        </div>
                        <div>
                            ${timeDisplay}
                            ${eventsDisplay}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('shiftResults').innerHTML = resultsHtml;
        }

        // é¸æŠæ©Ÿèƒ½ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡¨ç¤º
        function displaySelectionControls() {
            const controlsHtml = `
                <div style="text-align: center; margin: 20px 0; padding: 15px; background: #f0f8ff; border-radius: 10px;">
                    <h4 style="margin-bottom: 15px;">ğŸ¯ å‡ºå‹¤æ—¥é¸æŠ</h4>
                    <button class="btn btn-secondary" onclick="selectAllShifts()">ğŸ“‹ å…¨ã¦é¸æŠ</button>
                    <button class="btn btn-secondary" onclick="deselectAllShifts()">âŒ å…¨ã¦è§£é™¤</button>
                    <button class="btn btn-secondary" onclick="updateStatistics()">ğŸ“Š çµ±è¨ˆæ›´æ–°</button>
                </div>
            `;
            
            // çµæœã®ä¸Šã«æŒ¿å…¥
            const resultsSection = document.getElementById('shiftResults');
            resultsSection.insertAdjacentHTML('beforebegin', controlsHtml);
        }

        // ã‚·ãƒ•ãƒˆè¡¨ãƒœã‚¿ãƒ³è¡¨ç¤º
        function displayShiftTableButton() {
            const buttonHtml = `
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-success" onclick="generateShiftTable()">
                        ğŸ“‹ ã‚·ãƒ•ãƒˆè¡¨ã‚’ç”Ÿæˆ
                    </button>
                </div>
            `;
            
            document.getElementById('shiftResults').insertAdjacentHTML('afterend', buttonHtml);
        }

        // PDFå‡ºåŠ›
        function exportToPDF() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const settings = getCurrentSettings();
            
            alert(`${startDate}ã€œ${endDate}ã®ã‚·ãƒ•ãƒˆå¯èƒ½æ—¥ã‚’PDFå‡ºåŠ›ã—ã¾ã™ã€‚\nè¨­å®š: ${settings.startTime}ã€œ${settings.endTime}, æœ€ä½${settings.minHours}æ™‚é–“å‹¤å‹™\nï¼ˆå®Ÿè£…äºˆå®šæ©Ÿèƒ½ï¼‰`);
        }

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹é–¢é€£ã®æ©Ÿèƒ½
        function toggleShiftSelection(index) {
            if (globalShifts[index]) {
                globalShifts[index].selected = !globalShifts[index].selected;
                updateStatistics();
            }
        }

        function selectAllShifts() {
            globalShifts.forEach(shift => {
                if (shift.status === 'available') {
                    shift.selected = true;
                    const checkbox = document.getElementById(`shift-${globalShifts.indexOf(shift)}`);
                    if (checkbox) checkbox.checked = true;
                }
            });
            updateStatistics();
        }

        function deselectAllShifts() {
            globalShifts.forEach(shift => {
                if (shift.status === 'available') {
                    shift.selected = false;
                    const checkbox = document.getElementById(`shift-${globalShifts.indexOf(shift)}`);
                    if (checkbox) checkbox.checked = false;
                }
            });
            updateStatistics();
        }

        function updateStatistics() {
            const availableShifts = globalShifts.filter(s => s.status === 'available');
            const selectedShifts = availableShifts.filter(s => s.selected);
            const totalHours = availableShifts.reduce((sum, s) => sum + s.duration, 0);
            const selectedHours = selectedShifts.reduce((sum, s) => sum + s.duration, 0);

            // çµ±è¨ˆã‚’æ›´æ–°
            document.querySelector('.stat-card:nth-child(2) .stat-number').textContent = selectedShifts.length;
            document.querySelector('.stat-card:nth-child(4) .stat-number').textContent = selectedHours.toFixed(1);
        }

        // ã‚·ãƒ•ãƒˆè¡¨ç”Ÿæˆ
        function generateShiftTable() {
            const selectedShifts = globalShifts.filter(s => s.status === 'available' && s.selected);
            if (selectedShifts.length === 0) {
                alert('å‡ºå‹¤æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const userName = prompt('ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'ã‚·ãƒ•ãƒˆå¸Œæœ›è€…');
            if (!userName) return;

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            // æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ã‚·ãƒ•ãƒˆè¡¨ã‚’é–‹ã
            const newWindow = window.open('', '_blank', 'width=800,height=600');
            
            const tableHtml = generateShiftTableHTML(selectedShifts, userName, startDate, endDate);
            
            newWindow.document.write(tableHtml);
            newWindow.document.close();
        }

        // ã‚·ãƒ•ãƒˆè¡¨HTMLã®ç”Ÿæˆ
        function generateShiftTableHTML(selectedShifts, userName, startDate, endDate) {
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(endDate);
            
            // å¯¾è±¡ã¨ãªã‚‹æœˆã‚’ç‰¹å®š
            const months = [];
            for (let d = new Date(startDateObj); d <= endDateObj; d.setMonth(d.getMonth() + 1)) {
                months.push({
                    year: d.getFullYear(),
                    month: d.getMonth() + 1
                });
                d.setDate(1); // æœˆã®1æ—¥ã«è¨­å®šã—ã¦æ¬¡ã®æœˆã¸
            }
            const tableStyle = `
                <style>
                    body { font-family: 'Yu Gothic', sans-serif; margin: 20px; }
                    .shift-table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                    .shift-table th, .shift-table td { border: 2px solid #333; padding: 12px; text-align: center; }
                    .shift-table th { background-color: #4CAF50; color: white; font-weight: bold; }
                    .available-day { background-color: #e8f5e8; font-weight: bold; }
                    .header { text-align: center; margin-bottom: 30px; }
                    .info-section { margin: 20px 0; padding: 15px; background-color: #f9f9f9; border-radius: 5px; }
                    @media print { 
                        body { margin: 0; } 
                        .no-print { display: none; }
                    }
                </style>
            `;

            const period = months.length === 1 ? 
                `${months[0].year}å¹´${months[0].month}æœˆ` : 
                `${months[0].year}å¹´${months[0].month}æœˆã€œ${months[months.length-1].year}å¹´${months[months.length-1].month}æœˆ`;
                
            const headerSection = `
                <div class="header">
                    <h1>ğŸ—“ï¸ ${period} ã‚·ãƒ•ãƒˆå¸Œæœ›è¡¨</h1>
                    <h2>ğŸ‘¤ ${userName} æ§˜</h2>
                    <p>ä½œæˆæ—¥: ${new Date().toLocaleDateString('ja-JP')}</p>
                </div>
            `;

            const infoSection = `
                <div class="info-section">
                    <h3>ğŸ“‹ ã‚·ãƒ•ãƒˆå¸Œæœ›è©³ç´°</h3>
                    <p><strong>å¸Œæœ›è€…å:</strong> ${userName}</p>
                    <p><strong>å¯¾è±¡æœŸé–“:</strong> ${period}</p>
                    <p><strong>å‡ºå‹¤å¯èƒ½æ—¥æ•°:</strong> ${selectedShifts.length}æ—¥</p>
                    <p><strong>åˆè¨ˆå‹¤å‹™æ™‚é–“:</strong> ${selectedShifts.reduce((sum, s) => sum + s.duration, 0).toFixed(1)}æ™‚é–“</p>
                </div>
            `;

            // å„æœˆã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆ
            let allCalendarTables = '';
            
            months.forEach((monthData, index) => {
                const { year, month } = monthData;
                const firstDay = new Date(year, month - 1, 1);
                const lastDay = new Date(year, month, 0);
                const daysInMonth = lastDay.getDate();
                const startDayOfWeek = firstDay.getDay();

                let tableRows = '';
                let currentWeek = [];
                
                // ç©ºã®ã‚»ãƒ«ã§æœˆã®æœ€åˆã‚’åŸ‹ã‚ã‚‹
                for (let i = 0; i < startDayOfWeek; i++) {
                    currentWeek.push('<td></td>');
                }

                // å„æ—¥ã®ã‚»ãƒ«ã‚’ç”Ÿæˆ
                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = new Date(year, month - 1, day);
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const dayName = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][currentDate.getDay()];
                    
                    const selectedShift = selectedShifts.find(s => s.date === dateStr);
                    
                    if (selectedShift) {
                        currentWeek.push(`
                            <td class="available-day">
                                <div><strong>${day}</strong></div>
                                <div style="font-size: 0.9em;">(${dayName})</div>
                                <div style="font-size: 0.8em; color: #2e7d32;">
                                    ${selectedShift.availableTime}
                                </div>
                                <div style="font-size: 0.7em; color: #666;">
                                    ${selectedShift.duration.toFixed(1)}h
                                </div>
                            </td>
                        `);
                    } else {
                        currentWeek.push(`
                            <td>
                                <div>${day}</div>
                                <div style="font-size: 0.9em;">(${dayName})</div>
                            </td>
                        `);
                    }

                    // é€±æœ«ï¼ˆåœŸæ›œæ—¥ï¼‰ã§è¡Œã‚’çµ‚äº†
                    if (currentDate.getDay() === 6) {
                        tableRows += '<tr>' + currentWeek.join('') + '</tr>';
                        currentWeek = [];
                    }
                }

                // æœ€å¾Œã®é€±ã‚’å®Œæˆã•ã›ã‚‹
                if (currentWeek.length > 0) {
                    while (currentWeek.length < 7) {
                        currentWeek.push('<td></td>');
                    }
                    tableRows += '<tr>' + currentWeek.join('') + '</tr>';
                }

                // å„æœˆã®ãƒ†ãƒ¼ãƒ–ãƒ«
                const monthTable = `
                    <div style="${index > 0 ? 'page-break-before: always; margin-top: 40px;' : ''}">
                        <h2 style="text-align: center; color: #1976D2; margin-bottom: 20px;">${year}å¹´${month}æœˆ</h2>
                        <table class="shift-table">
                            <thead>
                                <tr>
                                    <th style="background-color: #ffcdd2;">æ—¥</th>
                                    <th>æœˆ</th>
                                    <th>ç«</th>
                                    <th>æ°´</th>
                                    <th>æœ¨</th>
                                    <th>é‡‘</th>
                                    <th style="background-color: #c3e0ff;">åœŸ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;
                
                allCalendarTables += monthTable;
            });
            
            const calendarTables = allCalendarTables;

            const detailTable = `
                <div style="margin-top: 30px;">
                    <h3>ğŸ“ å‡ºå‹¤å¸Œæœ›æ—¥ä¸€è¦§</h3>
                    <table class="shift-table">
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>æ›œæ—¥</th>
                                <th>å‡ºå‹¤æ™‚é–“å¸¯</th>
                                <th>å‹¤å‹™æ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${selectedShifts.map(shift => `
                                <tr>
                                    <td>${shift.date}</td>
                                    <td>${shift.dayName}</td>
                                    <td>${shift.availableTime}</td>
                                    <td>${shift.duration.toFixed(1)}æ™‚é–“</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            const printButton = `
                <div class="no-print" style="text-align: center; margin-top: 30px;">
                    <button onclick="window.print()" style="
                        background: #4CAF50; color: white; border: none; 
                        padding: 15px 30px; border-radius: 5px; cursor: pointer;
                        font-size: 16px;">
                        ğŸ–¨ï¸ å°åˆ·ã™ã‚‹
                    </button>
                    <button onclick="window.close()" style="
                        background: #f44336; color: white; border: none; 
                        padding: 15px 30px; border-radius: 5px; cursor: pointer;
                        font-size: 16px; margin-left: 10px;">
                        âŒ é–‰ã˜ã‚‹
                    </button>
                </div>
            `;

            return `
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>ã‚·ãƒ•ãƒˆå¸Œæœ›è¡¨ - ${userName}</title>
                    ${tableStyle}
                </head>
                <body>
                    ${headerSection}
                    ${infoSection}
                    ${calendarTables}
                    ${detailTable}
                    ${printButton}
                </body>
                </html>
            `;
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—æ©Ÿèƒ½
        let eventTooltip = null;

        function showEventTooltip(event, shiftIndex) {
            const shift = globalShifts[shiftIndex];
            if (!shift || !shift.events || shift.events.length === 0) {
                return;
            }

            // æ—¢å­˜ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’å‰Šé™¤
            hideEventTooltip();

            // æ–°ã—ã„ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’ä½œæˆ
            eventTooltip = document.createElement('div');
            eventTooltip.className = 'event-tooltip';
            
            // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®å†…å®¹ã‚’æ§‹ç¯‰
            let tooltipContent = `<h4>ğŸ“… ${shift.date} ã®äºˆå®š</h4>`;
            
            // æ™‚é–“æŒ‡å®šã®äºˆå®š
            const timeBasedEvents = shift.events.filter(e => !e.isAllDay);
            if (timeBasedEvents.length > 0) {
                timeBasedEvents.forEach(eventItem => {
                    tooltipContent += `
                        <div class="event-item">
                            <div class="event-title">â° ${eventItem.summary || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'}</div>
                            <div class="event-time">${eventItem.start} - ${eventItem.end}</div>
                            ${eventItem.location ? `<div class="event-location">ğŸ“ ${eventItem.location}</div>` : ''}
                            ${eventItem.description ? `<div class="event-description">ğŸ“ ${eventItem.description}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            // çµ‚æ—¥ã®äºˆå®š
            const allDayEvents = shift.events.filter(e => e.isAllDay);
            if (allDayEvents.length > 0) {
                allDayEvents.forEach(eventItem => {
                    tooltipContent += `
                        <div class="event-item">
                            <div class="event-title">ğŸ“… ${eventItem.originalSummary || eventItem.summary || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'}</div>
                            <div class="event-time">çµ‚æ—¥ã®äºˆå®š</div>
                            ${eventItem.location ? `<div class="event-location">ğŸ“ ${eventItem.location}</div>` : ''}
                            ${eventItem.description ? `<div class="event-description">ğŸ“ ${eventItem.description}</div>` : ''}
                            ${eventItem.isMultiDay ? `<div class="event-time">æœŸé–“: ${eventItem.eventStartDate} ã€œ ${eventItem.eventEndDate}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            if (timeBasedEvents.length === 0 && allDayEvents.length === 0) {
                tooltipContent += '<div class="no-events">ã“ã®æ—¥ã«ã¯äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“</div>';
            }
            
            eventTooltip.innerHTML = tooltipContent;
            document.body.appendChild(eventTooltip);
            
            // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®ä½ç½®ã‚’è¨­å®š
            const rect = event.target.closest('.shift-result').getBoundingClientRect();
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            
            eventTooltip.style.left = (rect.left + scrollLeft + 20) + 'px';
            eventTooltip.style.top = (rect.top + scrollTop - eventTooltip.offsetHeight - 10) + 'px';
            
            // ç”»é¢å¤–ã«ã¯ã¿å‡ºã™å ´åˆã®èª¿æ•´
            const tooltipRect = eventTooltip.getBoundingClientRect();
            if (tooltipRect.right > window.innerWidth) {
                eventTooltip.style.left = (window.innerWidth - tooltipRect.width - 20 + scrollLeft) + 'px';
            }
            if (tooltipRect.top < 0) {
                eventTooltip.style.top = (rect.bottom + scrollTop + 10) + 'px';
            }
            
            eventTooltip.style.display = 'block';
        }

        function hideEventTooltip() {
            if (eventTooltip) {
                document.body.removeChild(eventTooltip);
                eventTooltip = null;
            }
        }

        // CSVå‡ºåŠ›
        function exportToCSV() {
            const selectedShifts = globalShifts.filter(s => s.status === 'available' && s.selected);
            if (selectedShifts.length === 0) {
                alert('å‡ºå‹¤æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const csvContent = "data:text/csv;charset=utf-8," + 
                "æ—¥ä»˜,æ›œæ—¥,æ™‚é–“å¸¯,å‹¤å‹™æ™‚é–“,äºˆå®š\n" +
                selectedShifts.map(shift => 
                    `"${shift.date}","${shift.dayName}","${shift.availableTime}","${shift.duration.toFixed(1)}æ™‚é–“","${
                        shift.events && shift.events.length > 0 ? 
                        (() => {
                            const timeEvents = shift.events.filter(e => !e.isAllDay);
                            const allDayEvents = shift.events.filter(e => e.isAllDay);
                            let result = [];
                            if (timeEvents.length > 0) result.push(`æ™‚é–“æŒ‡å®š: ${timeEvents.map(e => e.summary).join(', ')}`);
                            if (allDayEvents.length > 0) result.push(`çµ‚æ—¥: ${allDayEvents.map(e => e.summary).join(', ')}`);
                            return result.join(' | ');
                        })() : '-'
                    }"`
                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "shift_schedule.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>