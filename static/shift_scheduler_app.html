<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>汎用シフト可能日計算アプリ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .settings-panel {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #2196F3;
        }

        .settings-panel h3 {
            color: #1976D2;
            margin-bottom: 20px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1em;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .form-control-small {
            width: 120px;
            display: inline-block;
            margin-right: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            border-color: #2196F3;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #2196F3;
        }

        .checkbox-item.checked {
            background: #e3f2fd;
            border-color: #2196F3;
        }

        .time-range {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
        }

        .btn-success:hover {
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        }


        .advanced-settings {
            background: #fff3e0;
            border-left: 5px solid #FF9800;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .advanced-settings h4 {
            color: #F57F17;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .results-section {
            margin-top: 30px;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 5px solid #FF9800;
            display: none;
        }

        .results-section.show {
            display: block;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .shift-result {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .shift-result:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .shift-result.available {
            border-left: 5px solid #4CAF50;
            background: linear-gradient(90deg, #e8f5e8 0%, white 100%);
        }

        .shift-result.partial {
            border-left: 5px solid #FF9800;
            background: linear-gradient(90deg, #fff3e0 0%, white 100%);
        }

        .shift-result.unavailable {
            border-left: 5px solid #f44336;
            background: linear-gradient(90deg, #ffebee 0%, white 100%);
        }

        .date-info {
            font-weight: 600;
            font-size: 1.1em;
            color: #333;
        }

        .time-badge {
            background: #2196F3;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .time-badge.partial {
            background: #FF9800;
        }

        .time-badge.unavailable {
            background: #f44336;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2196F3;
            display: block;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .current-settings {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #4CAF50;
        }

        .current-settings h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .setting-item {
            display: inline-block;
            background: white;
            padding: 5px 10px;
            margin: 3px;
            border-radius: 15px;
            font-size: 0.9em;
            border: 1px solid #c8e6c9;
        }

        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
            
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 13px;
            white-space: normal;
            max-width: 300px;
            width: max-content;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            line-height: 1.4;
        }

        .tooltip:hover::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #2c3e50;
            z-index: 1001;
        }

        /* ボタンのツールチップスタイル */
        button[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* 入力フィールドのツールチップ */
        input[title]:hover::after {
            content: attr(title);
            position: absolute;
            top: -35px;
            left: 0;
            background: #2c3e50;
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 15px 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #555;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px; /* border-bottomと重ならないように */
        }

        .tab-button:hover {
            color: #2196F3;
        }

        .tab-button.active {
            color: #2196F3;
            border-bottom-color: #2196F3;
            font-weight: 600;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .events-info {
            margin-top: 8px;
            padding: 5px 10px;
            background: #f0f8ff;
            border-radius: 5px;
            border-left: 3px solid #2196F3;
        }

        .shift-result {
            transition: all 0.3s ease;
        }

        .shift-result:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* イベント詳細ツールチップのスタイル */
        .event-tooltip {
            position: absolute;
            background: rgba(44, 62, 80, 0.95);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            line-height: 1.5;
            max-width: 300px;
            z-index: 2000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            display: none;
        }

        .event-tooltip h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #74c0fc;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 6px;
        }

        .event-tooltip .event-item {
            margin: 8px 0;
            padding: 6px;
            background: rgba(255,255,255,0.08);
            border-radius: 6px;
        }

        .event-tooltip .event-title {
            font-weight: bold;
            color: #ffd43b;
            margin-bottom: 4px;
        }

        .event-tooltip .event-time {
            color: #a5d8ff;
            font-size: 12px;
            margin-bottom: 3px;
        }

        .event-tooltip .event-location {
            color: #b2f2bb;
            font-size: 12px;
            margin-bottom: 3px;
        }

        .event-tooltip .event-description {
            color: #f8f9fa;
            font-size: 12px;
        }

        .event-tooltip .no-events {
            color: #adb5bd;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 汎用シフト可能日計算アプリ</h1>
            <p>あらゆる勤務条件に対応できる柔軟なシフト計算ツール</p>
        </div>

        <div class="content">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('settings-tab')">設定</button>
                <button class="tab-button" onclick="showTab('results-tab')">結果</button>
            </div>

            <div class="tab-content">
                <div id="settings-tab" class="tab-pane active">

            <!-- 現在の設定表示 -->
            <div class="current-settings" id="currentSettings">
                <h4>📋 現在の設定</h4>
                <div id="settingsDisplay"></div>
            </div>

            <!-- 設定パネル -->
            <div class="settings-grid">
                <!-- 基本設定 -->
                <div class="settings-panel">
                    <h3>⏰ 基本勤務条件</h3>
                    
                    <div class="form-group">
                        <label class="tooltip" data-tooltip="シフトで働くことができる時間帯を設定します。この時間外の予定は計算に影響しません。">
                            営業時間 ⓘ
                        </label>
                        <div class="time-range">
                            <input type="time" id="startTime" class="form-control form-control-small" value="10:00"
                                title="勤務開始可能な時刻">
                            <span>〜</span>
                            <input type="time" id="endTime" class="form-control form-control-small" value="18:00"
                                title="勤務終了時刻">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="tooltip" data-tooltip="連続して勤務できる最低時間">
                            最低勤務時間 ⓘ
                        </label>
                        <div class="time-range">
                            <input type="number" id="minHours" class="form-control form-control-small" value="2" min="0.5" step="0.5">
                            <span>時間</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="tooltip" data-tooltip="予定の前後に確保する移動・準備時間">
                            移動時間 ⓘ
                        </label>
                        <div class="time-range">
                            <input type="number" id="bufferTime" class="form-control form-control-small" value="30" min="0" step="15">
                            <span>分</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>除外する曜日</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude0" onchange="updateCheckboxUI(this)">
                                <label for="exclude0">日</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude1" onchange="updateCheckboxUI(this)">
                                <label for="exclude1">月</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude2" onchange="updateCheckboxUI(this)">
                                <label for="exclude2">火</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude3" onchange="updateCheckboxUI(this)">
                                <label for="exclude3">水</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude4" onchange="updateCheckboxUI(this)">
                                <label for="exclude4">木</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude5" onchange="updateCheckboxUI(this)">
                                <label for="exclude5">金</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="exclude6" onchange="updateCheckboxUI(this)">
                                <label for="exclude6">土</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 期間・カレンダー設定 -->
                <div class="settings-panel">
                    <h3>📅 期間・カレンダー設定</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="startDate" class="tooltip" data-tooltip="シフト計算を行う期間の開始日を設定します">
                                開始日 ⓘ
                            </label>
                            <input type="date" id="startDate" class="form-control" required
                                title="シフト計算開始日">
                        </div>
                        <div class="form-group">
                            <label for="endDate" class="tooltip" data-tooltip="シフト計算を行う期間の終了日を設定します">
                                終了日 ⓘ
                            </label>
                            <input type="date" id="endDate" class="form-control" required
                                title="シフト計算終了日">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="calendarId" class="tooltip" data-tooltip="Googleカレンダーの特定のカレンダーを指定できます。「primary」はメインカレンダーを意味します。他のカレンダーを使用する場合は、Googleカレンダーの設定からカレンダーIDを取得してください。">
                            カレンダーID ⓘ
                        </label>
                        <input type="text" id="calendarId" class="form-control" placeholder="primary" value="primary"
                            title="使用するGoogleカレンダーのID（primary = メインカレンダー）">
                    </div>

                    <!-- 高度な設定 -->
                    <div class="advanced-settings">
                        <h4>⚙️ 高度な設定</h4>
                        
                        <div class="form-group">
                            <label class="tooltip" data-tooltip="この時間未満の空き時間は勤務不可として扱います。短すぎる空き時間を除外できます。">
                                最小空き時間 ⓘ
                            </label>
                            <div class="time-range">
                                <input type="number" id="minGapTime" class="form-control form-control-small" value="30" min="0" step="15"
                                    title="勤務可能とする最小の空き時間（分）">
                                <span>分</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="tooltip" data-tooltip="1日あたりの最大勤務時間です。長時間の勤務を制限できます。">
                                最大勤務時間 ⓘ
                            </label>
                            <div class="time-range">
                                <input type="number" id="maxHours" class="form-control form-control-small" value="8" min="1" max="12" step="0.5"
                                    title="1日の最大勤務時間（時間）">
                                <span>時間</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="allowSplitShifts" onchange="updateCheckboxUI(this)">
                                <label for="allowSplitShifts" class="tooltip" data-tooltip="1日に複数の時間帯で勤務可能">
                                    分割シフト許可 ⓘ
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="excludeHolidays" onchange="updateCheckboxUI(this)">
                                <label for="excludeHolidays" class="tooltip" data-tooltip="日本の祝日を出勤不可にする">
                                    祝日を出勤不可にする ⓘ
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 認証状態表示 -->
            <div id="authStatus" style="text-align: center; margin: 20px 0; padding: 15px; background: #e8f5e8; border-radius: 10px; border-left: 5px solid #4CAF50; display: none;">
                <span style="color: #2e7d32; font-weight: bold;">
                    ✅ Googleアカウント認証済み
                </span>
                <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #555;">
                    カレンダー情報の取得が可能です
                </p>
            </div>

            <!-- 認証・実行ボタン -->
            <div style="text-align: center; margin: 30px 0;">
                <button class="btn btn-success" onclick="authenticateGoogle()" id="authButton" 
                    title="Googleカレンダーにアクセスするための認証を行います">
                    🔐 Googleアカウント認証
                </button>
                <button class="btn" onclick="calculateShifts()" id="calculateButton" disabled
                    title="設定した条件でシフト可能日を計算します">
                    🔄 シフト可能日を計算
                </button>
                <button class="btn btn-secondary" onclick="saveSettings()"
                    title="現在の設定をブラウザに保存します">
                    💾 設定を保存
                </button>
                <button class="btn btn-secondary" onclick="loadSettings()"
                    title="保存した設定を読み込みます">
                    📂 設定を読込
                </button>
            </div>
                </div>

                <div id="results-tab" class="tab-pane">
                    <!-- 結果表示エリア -->
                    <div id="resultsSection" class="results-section">
                        <div id="loadingDiv" class="loading">
                            <div class="spinner"></div>
                            <p>カレンダー情報を取得中...</p>
                        </div>
                        
                        <div id="resultsContent" style="display: none;">
                            <h3>📊 計算結果</h3>
                            <div id="summaryStats" class="summary-stats"></div>
                            <div id="shiftResults"></div>
                            
                            <div style="text-align: center; margin-top: 30px;">
                                <button class="btn btn-success" onclick="exportToPDF()">
                                    📄 PDF出力
                                </button>
                                <button class="btn btn-secondary" onclick="exportToCSV()">
                                    📊 CSV出力
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Google認証
        function authenticateGoogle() {
            window.location.href = '/auth/google/login';
        }

        // 認証状態確認（アプリ起動時とAPI失敗時に呼び出される）
        async function checkAuthStatus() {
            console.log('認証状態を確認中...');
            
            const authButton = document.getElementById('authButton');
            const calculateButton = document.getElementById('calculateButton');
            const authStatus = document.getElementById('authStatus');
            
            // 初期状態：認証状態不明
            authStatus.style.display = 'none';
            authButton.style.display = 'inline-flex';
            calculateButton.disabled = true;
            
            try {
                // 実際にカレンダーAPIを呼び出して認証状態を確認
                const testDate = new Date().toISOString().split('T')[0];
                const response = await fetch(`/api/calendar/events?startDate=${testDate}&endDate=${testDate}&calendarId=primary`);
                
                console.log('API応答ステータス:', response.status);
                
                if (response.ok) {
                    // 認証済み：カレンダーデータ取得成功
                    const data = await response.json();
                    console.log('認証成功：カレンダーデータ取得完了', data.length + '件のイベント');
                    
                    authButton.style.display = 'none';
                    calculateButton.disabled = false;
                    authStatus.style.display = 'block';
                    
                    return true;
                } else if (response.status === 401) {
                    // 未認証
                    console.log('未認証：認証が必要です');
                    
                    authButton.style.display = 'inline-flex';
                    authButton.textContent = '🔐 Googleアカウント認証';
                    calculateButton.disabled = true;
                    authStatus.style.display = 'none';
                    
                    return false;
                } else {
                    // その他のエラー
                    console.log('API エラー:', response.status);
                    const errorData = await response.json().catch(() => ({}));
                    console.log('エラー詳細:', errorData);
                    
                    authButton.style.display = 'inline-flex';
                    authButton.textContent = '🔐 再認証が必要';
                    calculateButton.disabled = true;
                    authStatus.style.display = 'none';
                    
                    return false;
                }
            } catch (error) {
                console.error('認証状態確認エラー:', error);
                
                // ネットワークエラーなどの場合
                authButton.style.display = 'inline-flex';
                authButton.textContent = '🔐 認証状態確認失敗';
                calculateButton.disabled = true;
                authStatus.style.display = 'none';
                
                return false;
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            // 今日の日付を設定
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            
            // 2週間後を終了日に設定
            const twoWeeksLater = new Date();
            twoWeeksLater.setDate(twoWeeksLater.getDate() + 14);
            document.getElementById('endDate').value = twoWeeksLater.toISOString().split('T')[0];

            // デフォルトで水曜と日曜を除外
            document.getElementById('exclude0').checked = true;
            document.getElementById('exclude3').checked = true;
            updateAllCheckboxUI();
            
            updateSettingsDisplay();
            
            // 設定変更時のリアルタイム更新
            document.addEventListener('input', updateSettingsDisplay);
            document.addEventListener('change', updateSettingsDisplay);

            // 初期表示は設定タブ
            showTab('settings-tab');

            // アプリ起動時に認証状態を自動確認
            console.log('アプリケーション起動：認証状態を確認します');
            checkAuthStatus();
        });

        // タブ切り替え関数
        function showTab(tabId) {
            // すべてのタブコンテンツを非表示にし、activeクラスを削除
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // 指定されたタブコンテンツを表示し、activeクラスを追加
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');

            // 結果タブに切り替わった際にresultsSectionを表示
            if (tabId === 'results-tab') {
                document.getElementById('resultsSection').classList.add('show');
            } else {
                document.getElementById('resultsSection').classList.remove('show');
            }
        }

        // 設定リセット
        function resetSettings() {
            document.getElementById('startTime').value = '09:00';
            document.getElementById('endTime').value = '17:00';
            document.getElementById('minHours').value = '2';
            document.getElementById('bufferTime').value = '30';
            document.getElementById('maxHours').value = '8';
            document.getElementById('minGapTime').value = '30';
            document.getElementById('allowSplitShifts').checked = false;
            document.getElementById('excludeHolidays').checked = false;

            for (let i = 0; i < 7; i++) {
                document.getElementById(`exclude${i}`).checked = false;
            }

            updateAllCheckboxUI();
            updateSettingsDisplay();
        }

        // チェックボックスのUI更新
        function updateCheckboxUI(checkbox) {
            const item = checkbox.closest('.checkbox-item');
            if (checkbox.checked) {
                item.classList.add('checked');
            } else {
                item.classList.remove('checked');
            }
        }

        function updateAllCheckboxUI() {
            for (let i = 0; i < 7; i++) {
                updateCheckboxUI(document.getElementById(`exclude${i}`));
            }
            updateCheckboxUI(document.getElementById('allowSplitShifts'));
            updateCheckboxUI(document.getElementById('excludeHolidays'));
        }

        // 現在の設定表示を更新
        function updateSettingsDisplay() {
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const minHours = document.getElementById('minHours').value;
            const bufferTime = document.getElementById('bufferTime').value;
            const maxHours = document.getElementById('maxHours').value;
            const minGapTime = document.getElementById('minGapTime').value;
            const allowSplitShifts = document.getElementById('allowSplitShifts').checked;
            const excludeHolidays = document.getElementById('excludeHolidays').checked;

            const excludedDays = [];
            const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
            for (let i = 0; i < 7; i++) {
                if (document.getElementById(`exclude${i}`).checked) {
                    excludedDays.push(dayNames[i]);
                }
            }

            const displayHTML = `
                <span class="setting-item">⏰ ${startTime}〜${endTime}</span>
                <span class="setting-item">⏱️ 最低${minHours}時間</span>
                <span class="setting-item">🚶 移動${bufferTime}分</span>
                <span class="setting-item">📊 最大${maxHours}時間</span>
                <span class="setting-item">⚡ 最小空き${minGapTime}分</span>
                ${excludedDays.length > 0 ? `<span class="setting-item">🚫 ${excludedDays.join('・')}曜日除外</span>` : ''}
                ${allowSplitShifts ? '<span class="setting-item">✂️ 分割シフト可</span>' : ''}
                ${excludeHolidays ? '<span class="setting-item">🎌 祝日除外</span>' : ''}
            `;

            document.getElementById('settingsDisplay').innerHTML = displayHTML;
        }

        // 設定の保存
        function saveSettings() {
            const settings = {
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                minHours: document.getElementById('minHours').value,
                bufferTime: document.getElementById('bufferTime').value,
                maxHours: document.getElementById('maxHours').value,
                minGapTime: document.getElementById('minGapTime').value,
                allowSplitShifts: document.getElementById('allowSplitShifts').checked,
                excludeHolidays: document.getElementById('excludeHolidays').checked,
                excludedDays: []
            };

            for (let i = 0; i < 7; i++) {
                if (document.getElementById(`exclude${i}`).checked) {
                    settings.excludedDays.push(i);
                }
            }

            localStorage.setItem('shiftCalculatorSettings', JSON.stringify(settings));
            alert('設定を保存しました！');
        }

        // 設定の読み込み
        function loadSettings() {
            const saved = localStorage.getItem('shiftCalculatorSettings');
            if (!saved) {
                alert('保存された設定が見つかりません。');
                return;
            }

            const settings = JSON.parse(saved);
            
            document.getElementById('startTime').value = settings.startTime;
            document.getElementById('endTime').value = settings.endTime;
            document.getElementById('minHours').value = settings.minHours;
            document.getElementById('bufferTime').value = settings.bufferTime;
            document.getElementById('maxHours').value = settings.maxHours;
            document.getElementById('minGapTime').value = settings.minGapTime;
            document.getElementById('allowSplitShifts').checked = settings.allowSplitShifts;
            document.getElementById('excludeHolidays').checked = settings.excludeHolidays;

            for (let i = 0; i < 7; i++) {
                document.getElementById(`exclude${i}`).checked = settings.excludedDays.includes(i);
            }

            updateAllCheckboxUI();
            updateSettingsDisplay();
            alert('設定を読み込みました！');
        }

        // 現在の設定を取得
        function getCurrentSettings() {
            const excludedDays = [];
            for (let i = 0; i < 7; i++) {
                if (document.getElementById(`exclude${i}`).checked) {
                    excludedDays.push(i);
                }
            }

            return {
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                minHours: parseFloat(document.getElementById('minHours').value),
                bufferTime: parseInt(document.getElementById('bufferTime').value),
                maxHours: parseFloat(document.getElementById('maxHours').value),
                minGapTime: parseInt(document.getElementById('minGapTime').value),
                allowSplitShifts: document.getElementById('allowSplitShifts').checked,
                excludeHolidays: document.getElementById('excludeHolidays').checked,
                excludedDays: excludedDays
            };
        }

        // シフト計算のメイン関数
        async function calculateShifts() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const calendarId = document.getElementById('calendarId').value || 'primary';
            const settings = getCurrentSettings();

            if (!startDate || !endDate) {
                alert('開始日と終了日を入力してください。');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('開始日は終了日より前の日付を選択してください。');
                return;
            }

            // 結果タブに切り替え
            showTab('results-tab');
            
            // 結果セクションを表示
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.add('show');
            
            // ローディング表示
            document.getElementById('loadingDiv').style.display = 'block';
            document.getElementById('resultsContent').style.display = 'none';

            try {
                // バックエンドからカレンダー情報を取得
                await fetchCalendarDataFromBackend(startDate, endDate, calendarId, settings);
            } catch (error) {
                console.error('エラー:', error);
                
                // エラー時は認証状態を再確認して適切なUIを表示
                const isAuthenticated = await checkAuthStatus();
                if (!isAuthenticated) {
                    alert('カレンダー情報の取得に失敗しました。認証ボタンをクリックしてGoogleアカウントで認証してください。');
                } else {
                    alert('カレンダー情報の取得に失敗しました。しばらく待ってから再試行してください。');
                }
                document.getElementById('loadingDiv').style.display = 'none';
            }
        }

        // バックエンドからカレンダー情報を取得
        async function fetchCalendarDataFromBackend(startDate, endDate, calendarId, settings) {
            try {
                // バックエンドAPIを呼び出してカレンダーイベントを取得
                const response = await fetch(`/api/calendar/events?startDate=${startDate}&endDate=${endDate}&calendarId=${calendarId}`);
                
                if (response.status === 401) {
                    // 認証が必要な場合：認証状態を更新してボタンを表示
                    console.log('認証エラー：認証状態を更新します');
                    await checkAuthStatus(); // 認証状態を更新
                    
                    alert('カレンダー情報の取得に失敗しました。Googleアカウントでの認証が必要です。');
                    document.getElementById('loadingDiv').style.display = 'none';
                    return;
                }
                
                if (!response.ok) {
                    // その他のAPIエラー
                    console.log('APIエラー:', response.status);
                    const errorData = await response.json().catch(() => ({}));
                    console.log('エラー詳細:', errorData);
                    
                    // 認証状態を再確認
                    await checkAuthStatus();
                    
                    throw new Error(`カレンダーAPI error! status: ${response.status}, message: ${errorData.error || 'Unknown error'}`);
                }
                
                const events = await response.json();
                console.log('取得したイベント:', events);
                
                // 取得したイベントを使ってシフトを計算
                await calculateShiftsWithRealData(startDate, endDate, events, settings);
                
            } catch (error) {
                console.error('バックエンドAPI呼び出しエラー:', error);
                
                // エラー時は認証状態を再確認
                await checkAuthStatus();
                throw error;
            }
        }

        // 実際のカレンダーデータを使用したシフト計算
        async function calculateShiftsWithRealData(startDate, endDate, events, settings) {
            let holidays = {};
            if (settings.excludeHolidays) {
                try {
                    const startYear = new Date(startDate).getFullYear();
                    const endYear = new Date(endDate).getFullYear();
                    for (let year = startYear; year <= endYear; year++) {
                        const response = await fetch(`https://holidays-jp.github.io/api/v1/${year}/date.json`);
                        if (response.ok) {
                            const yearHolidays = await response.json();
                            holidays = { ...holidays, ...yearHolidays };
                        }
                    }
                } catch (error) {
                    console.error("Error fetching holidays:", error);
                }
            }

            // イベントを日付ごとにグループ化（計算用と表示用を分離）
            const eventsByDate = {}; // 時間指定のあるイベント（計算用）
            const allDayEventsByDate = {}; // 終日イベント（表示専用）
            
            events.forEach(event => {
                // 終日イベントかどうかをチェック
                if (event.start.includes('T') && event.end.includes('T')) {
                    // 時間指定のあるイベント（計算に使用）
                    const eventDate = event.start.split('T')[0];
                    if (!eventsByDate[eventDate]) {
                        eventsByDate[eventDate] = [];
                    }
                    eventsByDate[eventDate].push({
                        start: event.start.split('T')[1].substring(0, 5),
                        end: event.end.split('T')[1].substring(0, 5),
                        summary: event.summary,
                        location: event.location,
                        description: event.description,
                        isAllDay: false
                    });
                } else {
                    // 終日イベント（表示のみ）- 複数日対応
                    const startDate = new Date(event.start);
                    const endDate = new Date(event.end);
                    
                    // 終了日から1日引く（Googleカレンダーの終日イベントは翌日の00:00が終了時刻）
                    endDate.setDate(endDate.getDate() - 1);
                    
                    // 開始日から終了日まで各日に追加
                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        const dateStr = d.toISOString().split('T')[0];
                        
                        if (!allDayEventsByDate[dateStr]) {
                            allDayEventsByDate[dateStr] = [];
                        }
                        
                        // 複数日の場合は日数情報を追加
                        const isMultiDay = startDate.getTime() !== endDate.getTime();
                        const dayInfo = isMultiDay ? 
                            ` (${startDate.toLocaleDateString('ja-JP', {month: 'short', day: 'numeric'})}〜${endDate.toLocaleDateString('ja-JP', {month: 'short', day: 'numeric'})})` : '';
                        
                        allDayEventsByDate[dateStr].push({
                            start: '終日',
                            end: '終日',
                            summary: event.summary + dayInfo,
                            originalSummary: event.summary,
                            location: event.location,
                            description: event.description,
                            isAllDay: true,
                            isMultiDay: isMultiDay,
                            eventStartDate: startDate.toISOString().split('T')[0],
                            eventEndDate: endDate.toISOString().split('T')[0],
                            currentDate: dateStr
                        });
                    }
                }
            });

            // 設定に基づいてシフトを計算
            const shifts = calculateShiftsWithRealEvents(startDate, endDate, eventsByDate, allDayEventsByDate, settings, holidays);
            displayResults(shifts, settings);
        }

        // 実際のイベントデータを使用したシフト計算
        function calculateShiftsWithRealEvents(startDate, endDate, eventsByDate, allDayEventsByDate, settings, holidays) {
            const shifts = [];
            const start = new Date(startDate);
            const end = new Date(endDate);

            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                const dayOfWeek = date.getDay();
                const dateStr = date.toISOString().split('T')[0];
                const dayName = ['日', '月', '火', '水', '木', '金', '土'][dayOfWeek];

                // 除外曜日チェック
                if (settings.excludedDays.includes(dayOfWeek)) {
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'excluded',
                        reason: `${dayName}曜日のため対象外`,
                        availableTime: null,
                        duration: 0,
                        shifts: [],
                        events: [...(eventsByDate[dateStr] || []), ...(allDayEventsByDate[dateStr] || [])],
                        selected: false
                    });
                    continue;
                }

                // 祝日除外チェック
                if (settings.excludeHolidays && holidays[dateStr]) {
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'excluded',
                        reason: `祝日（${holidays[dateStr]}）のため対象外`,
                        availableTime: null,
                        duration: 0,
                        shifts: [],
                        events: [...(eventsByDate[dateStr] || []), ...(allDayEventsByDate[dateStr] || [])],
                        selected: false
                    });
                    continue;
                }

                // その日のイベントを取得（計算用：時間指定のみ）
                const dayEvents = eventsByDate[dateStr] || [];
                
                // その日の終日イベントを取得（表示用）
                const allDayEvents = allDayEventsByDate[dateStr] || [];
                
                // 表示用に全イベントを結合
                const allEventsForDisplay = [...dayEvents, ...allDayEvents];
                
                // 営業時間内の利用可能時間を計算
                const availableSlots = calculateAvailableSlots(
                    settings.startTime,
                    settings.endTime,
                    dayEvents,
                    settings
                );

                // 利用可能スロット（既に最低勤務時間チェック済み）
                const validSlots = availableSlots;

                if (validSlots.length > 0) {
                    const totalDuration = validSlots.reduce((sum, slot) => sum + slot.duration, 0);
                    const maxDuration = Math.min(totalDuration, settings.maxHours);

                    if (settings.allowSplitShifts && validSlots.length > 1) {
                        shifts.push({
                            date: dateStr,
                            dayName: dayName,
                            status: 'available',
                            reason: '複数時間帯で勤務可能',
                            availableTime: validSlots.map(slot => `${slot.start}-${slot.end}`).join(', '),
                            duration: maxDuration,
                            shifts: validSlots,
                            events: allEventsForDisplay,
                            selected: true  // デフォルトで選択状態
                        });
                    } else {
                        const bestSlot = validSlots[0];
                        const adjustedEnd = maxDuration < bestSlot.duration ? 
                            addHours(bestSlot.start, maxDuration) : bestSlot.end;
                        
                        shifts.push({
                            date: dateStr,
                            dayName: dayName,
                            status: 'available',
                            reason: '勤務可能',
                            availableTime: `${bestSlot.start}-${adjustedEnd}`,
                            duration: Math.min(bestSlot.duration, maxDuration),
                            shifts: [{ start: bestSlot.start, end: adjustedEnd, duration: Math.min(bestSlot.duration, maxDuration) }],
                            events: allEventsForDisplay,
                            selected: true  // デフォルトで選択状態
                        });
                    }
                } else {
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'unavailable',
                        reason: dayEvents.length > 0 ? '予定により最低勤務時間確保不可' : '勤務時間確保不可',
                        availableTime: null,
                        duration: 0,
                        shifts: [],
                        events: dayEvents,
                        selected: false
                    });
                }
            }

            return shifts;
        }

        // カレンダー取得とシフト計算のシミュレーション（デモ用）
        async function simulateCalendarFetch(startDate, endDate, calendarId, settings) {
            await new Promise(resolve => setTimeout(resolve, 2000));

            let holidays = {};
            if (settings.excludeHolidays) {
                try {
                    const startYear = new Date(startDate).getFullYear();
                    const endYear = new Date(endDate).getFullYear();
                    for (let year = startYear; year <= endYear; year++) {
                        const response = await fetch(`https://holidays-jp.github.io/api/v1/${year}/date.json`);
                        if (!response.ok) {
                            throw new Error(`Failed to fetch holidays for ${year}: ${response.statusText}`);
                        }
                        const yearHolidays = await response.json();
                        holidays = { ...holidays, ...yearHolidays };
                    }
                    console.log("Fetched holidays:", holidays);
                } catch (error) {
                    console.error("Error fetching holidays:", error);
                    alert("祝日情報の取得に失敗しました。祝日除外設定は適用されません。");
                }
            }

            // 設定に基づいてシフトを計算
            const shifts = calculateShiftsWithSettings(startDate, endDate, settings, holidays);
            displayResults(shifts, settings);
        }

        // 設定に基づくシフト計算
        function calculateShiftsWithSettings(startDate, endDate, settings, holidays) {
            const shifts = [];
            const start = new Date(startDate);
            const end = new Date(endDate);

            for (let date = new Date(start); date <= end; date.setDate(date.getDate() + 1)) {
                const dayOfWeek = date.getDay();
                const dateStr = date.toISOString().split('T')[0];
                const dayName = ['日', '月', '火', '水', '木', '金', '土'][dayOfWeek];

                // 除外曜日チェック
                if (settings.excludedDays.includes(dayOfWeek)) {
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'excluded',
                        reason: `${dayName}曜日のため対象外`,
                        availableTime: null,
                        duration: 0,
                        shifts: [],
                        events: [...(eventsByDate[dateStr] || []), ...(allDayEventsByDate[dateStr] || [])],
                        selected: false
                    });
                    continue;
                }

                // 祝日除外チェック
                if (settings.excludeHolidays && holidays[dateStr]) {
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'excluded',
                        reason: `祝日（${holidays[dateStr]}）のため対象外`,
                        availableTime: null,
                        duration: 0,
                        shifts: [],
                        events: [...(eventsByDate[dateStr] || []), ...(allDayEventsByDate[dateStr] || [])],
                        selected: false
                    });
                    continue;
                }

                // ランダムに予定を生成（デモ用）
                const hasEvent = Math.random() < 0.4; // 40%の確率で予定あり
                let availableSlots = [];

                if (hasEvent) {
                    // 予定がある場合のシミュレーション
                    const eventStart = randomTime(settings.startTime, settings.endTime);
                    const eventDuration = Math.random() * 4 + 1; // 1-5時間の予定
                    const eventEnd = addHours(eventStart, eventDuration);

                    // 営業時間内の利用可能時間を計算
                    availableSlots = calculateAvailableSlots(
                        settings.startTime,
                        settings.endTime,
                        [{start: eventStart, end: eventEnd}],
                        settings
                    );
                } else {
                    // 予定がない場合は全時間利用可能
                    availableSlots = [{
                        start: settings.startTime,
                        end: settings.endTime,
                        duration: calculateDuration(settings.startTime, settings.endTime)
                    }];
                }

                // 最低勤務時間を満たすスロットをフィルタリング
                const validSlots = availableSlots.filter(slot => slot.duration >= settings.minHours);

                if (validSlots.length > 0) {
                    const totalDuration = validSlots.reduce((sum, slot) => sum + slot.duration, 0);
                    const maxDuration = Math.min(totalDuration, settings.maxHours);

                    if (settings.allowSplitShifts && validSlots.length > 1) {
                        shifts.push({
                            date: dateStr,
                            dayName: dayName,
                            status: 'available',
                            reason: '複数時間帯で勤務可能',
                            availableTime: validSlots.map(slot => `${slot.start}-${slot.end}`).join(', '),
                            duration: maxDuration,
                            shifts: validSlots,
                            events: allEventsForDisplay,
                            selected: true  // デフォルトで選択状態
                        });
                    } else {
                        const bestSlot = validSlots[0];
                        const adjustedEnd = maxDuration < bestSlot.duration ? 
                            addHours(bestSlot.start, maxDuration) : bestSlot.end;
                        
                        shifts.push({
                            date: dateStr,
                            dayName: dayName,
                            status: 'available',
                            reason: '勤務可能',
                            availableTime: `${bestSlot.start}-${adjustedEnd}`,
                            duration: Math.min(bestSlot.duration, maxDuration),
                            shifts: [{ start: bestSlot.start, end: adjustedEnd, duration: Math.min(bestSlot.duration, maxDuration) }],
                            events: allEventsForDisplay,
                            selected: true  // デフォルトで選択状態
                        });
                    }
                } else {
                    shifts.push({
                        date: dateStr,
                        dayName: dayName,
                        status: 'unavailable',
                        reason: hasEvent ? '予定により最低勤務時間確保不可' : '勤務時間確保不可',
                        availableTime: null,
                        duration: 0,
                        shifts: []
                    });
                }
            }

            return shifts;
        }

        // 利用可能時間スロット計算
        function calculateAvailableSlots(startTime, endTime, events, settings) {
            const slots = [];
            const workStart = timeToMinutes(startTime);
            const workEnd = timeToMinutes(endTime);

            // イベントを時間順にソート
            events.sort((a, b) => timeToMinutes(a.start) - timeToMinutes(b.start));

            let currentStart = workStart;

            for (const event of events) {
                // イベントの時間を分に変換し、移動時間を考慮
                const eventStartMinutes = timeToMinutes(event.start);
                const eventEndMinutes = timeToMinutes(event.end);
                
                // 営業時間外のイベントは無視
                if (eventEndMinutes <= workStart || eventStartMinutes >= workEnd) {
                    continue;
                }
                
                // 移動時間を考慮したイベントの開始・終了時間
                const blockedStart = Math.max(workStart, eventStartMinutes - settings.bufferTime);
                const blockedEnd = Math.min(workEnd, eventEndMinutes + settings.bufferTime);

                // 現在位置からブロックされた開始時間までに利用可能な時間があるか
                if (currentStart < blockedStart) {
                    const slotDuration = (blockedStart - currentStart) / 60;
                    // 最小空き時間と最低勤務時間の両方をチェック
                    if (slotDuration >= Math.max(settings.minGapTime / 60, settings.minHours)) {
                        slots.push({
                            start: minutesToTime(currentStart),
                            end: minutesToTime(blockedStart),
                            duration: slotDuration
                        });
                    }
                }

                // 次の開始可能時間を更新
                currentStart = Math.max(currentStart, blockedEnd);
            }

            // 最後のスロット（最後のイベント後から営業時間終了まで）
            if (currentStart < workEnd) {
                const slotDuration = (workEnd - currentStart) / 60;
                // 最小空き時間と最低勤務時間の両方をチェック
                if (slotDuration >= Math.max(settings.minGapTime / 60, settings.minHours)) {
                    slots.push({
                        start: minutesToTime(currentStart),
                        end: minutesToTime(workEnd),
                        duration: slotDuration
                    });
                }
            }

            return slots;
        }

        // ユーティリティ関数
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        function calculateDuration(startTime, endTime) {
            return (timeToMinutes(endTime) - timeToMinutes(startTime)) / 60;
        }

        function addHours(timeStr, hours) {
            const startMinutes = timeToMinutes(timeStr);
            const endMinutes = startMinutes + (hours * 60);
            return minutesToTime(Math.round(endMinutes));
        }

        function randomTime(startTime, endTime) {
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = timeToMinutes(endTime);
            const randomMinutes = startMinutes + Math.random() * (endMinutes - startMinutes);
            return minutesToTime(Math.round(randomMinutes));
        }

        // グローバル変数でシフトデータを保存
        let globalShifts = [];

        // 結果表示
        function displayResults(shifts, settings) {
            globalShifts = shifts; // グローバル変数に保存
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('resultsContent').style.display = 'block';

            // 統計計算
            const availableShifts = shifts.filter(s => s.status === 'available');
            const partialShifts = shifts.filter(s => s.status === 'partial');
            const unavailableShifts = shifts.filter(s => s.status === 'unavailable');
            const excludedShifts = shifts.filter(s => s.status === 'excluded');
            const selectedShifts = availableShifts.filter(s => s.selected);
            const totalHours = availableShifts.reduce((sum, s) => sum + s.duration, 0);
            const selectedHours = selectedShifts.reduce((sum, s) => sum + s.duration, 0);
            const avgHoursPerDay = availableShifts.length > 0 ? (totalHours / availableShifts.length) : 0;

            // 統計表示
            const statsHtml = `
                <div class="stat-card">
                    <span class="stat-number">${availableShifts.length}</span>
                    <div class="stat-label">出勤可能日</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" style="color: #4CAF50;">${selectedShifts.length}</span>
                    <div class="stat-label">選択済み出勤日</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${totalHours.toFixed(1)}</span>
                    <div class="stat-label">合計勤務時間</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" style="color: #4CAF50;">${selectedHours.toFixed(1)}</span>
                    <div class="stat-label">選択済み勤務時間</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${unavailableShifts.length + excludedShifts.length}</span>
                    <div class="stat-label">出勤不可・除外日</div>
                </div>
            `;
            document.getElementById('summaryStats').innerHTML = statsHtml;

            // 詳細な結果表示
            displayDetailedResults(shifts);
            
            // 選択機能ボタンを表示
            displaySelectionControls();
            
            // シフト表生成ボタンを表示
            displayShiftTableButton();
        }

        // 詳細な結果表示
        function displayDetailedResults(shifts) {
            const resultsHtml = shifts.map((shift, index) => {
                const statusClass = shift.status === 'excluded' ? 'unavailable' : shift.status;
                const statusIcon = {
                    'available': '✅',
                    'partial': '⚠️',
                    'unavailable': '❌',
                    'excluded': '🚫'
                }[shift.status];

                // イベント情報の表示（終日予定と時間指定予定を分けて表示）
                let eventsDisplay = '';
                if (shift.events && shift.events.length > 0) {
                    const timeBasedEvents = shift.events.filter(event => !event.isAllDay);
                    const allDayEvents = shift.events.filter(event => event.isAllDay);
                    
                    let eventTexts = [];
                    
                    // 時間指定の予定
                    if (timeBasedEvents.length > 0) {
                        eventTexts.push(`⏰ 時間指定: ${timeBasedEvents.map(event => 
                            `${event.summary} (${event.start}-${event.end})`
                        ).join(', ')}`);
                    }
                    
                    // 終日予定
                    if (allDayEvents.length > 0) {
                        eventTexts.push(`📅 終日の予定: ${allDayEvents.map(event => 
                            event.summary
                        ).join(', ')}`);
                    }
                    
                    if (eventTexts.length > 0) {
                        eventsDisplay = `<div class="events-info">
                            <small>${eventTexts.join(' | ')}</small>
                        </div>`;
                    }
                }

                // チェックボックス（出勤可能日のみ）
                const checkbox = shift.status === 'available' ? 
                    `<input type="checkbox" id="shift-${index}" ${shift.selected ? 'checked' : ''} 
                     onchange="toggleShiftSelection(${index})" style="margin-right: 10px;">` : '';

                // ツールチップ用のイベント情報を準備
                const tooltipData = shift.events ? JSON.stringify(shift.events).replace(/"/g, '&quot;') : '[]';

                const timeDisplay = shift.availableTime ? 
                    `<span class="time-badge ${statusClass}">${shift.availableTime} (${shift.duration.toFixed(1)}h)</span>` :
                    `<span class="time-badge unavailable">${shift.reason}</span>`;

                return `
                    <div class="shift-result ${statusClass}" id="shift-row-${index}" 
                         data-events='${tooltipData}'
                         onmouseenter="showEventTooltip(event, ${index})" 
                         onmouseleave="hideEventTooltip()">
                        <div class="date-info">
                            ${checkbox}${statusIcon} ${shift.date} (${shift.dayName})
                        </div>
                        <div>
                            ${timeDisplay}
                            ${eventsDisplay}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('shiftResults').innerHTML = resultsHtml;
        }

        // 選択機能コントロール表示
        function displaySelectionControls() {
            const controlsHtml = `
                <div style="text-align: center; margin: 20px 0; padding: 15px; background: #f0f8ff; border-radius: 10px;">
                    <h4 style="margin-bottom: 15px;">🎯 出勤日選択</h4>
                    <button class="btn btn-secondary" onclick="selectAllShifts()">📋 全て選択</button>
                    <button class="btn btn-secondary" onclick="deselectAllShifts()">❌ 全て解除</button>
                    <button class="btn btn-secondary" onclick="updateStatistics()">📊 統計更新</button>
                </div>
            `;
            
            // 結果の上に挿入
            const resultsSection = document.getElementById('shiftResults');
            resultsSection.insertAdjacentHTML('beforebegin', controlsHtml);
        }

        // シフト表ボタン表示
        function displayShiftTableButton() {
            const buttonHtml = `
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-success" onclick="generateShiftTable()">
                        📋 シフト表を生成
                    </button>
                </div>
            `;
            
            document.getElementById('shiftResults').insertAdjacentHTML('afterend', buttonHtml);
        }

        // PDF出力
        function exportToPDF() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const settings = getCurrentSettings();
            
            alert(`${startDate}〜${endDate}のシフト可能日をPDF出力します。\n設定: ${settings.startTime}〜${settings.endTime}, 最低${settings.minHours}時間勤務\n（実装予定機能）`);
        }

        // チェックボックス関連の機能
        function toggleShiftSelection(index) {
            if (globalShifts[index]) {
                globalShifts[index].selected = !globalShifts[index].selected;
                updateStatistics();
            }
        }

        function selectAllShifts() {
            globalShifts.forEach(shift => {
                if (shift.status === 'available') {
                    shift.selected = true;
                    const checkbox = document.getElementById(`shift-${globalShifts.indexOf(shift)}`);
                    if (checkbox) checkbox.checked = true;
                }
            });
            updateStatistics();
        }

        function deselectAllShifts() {
            globalShifts.forEach(shift => {
                if (shift.status === 'available') {
                    shift.selected = false;
                    const checkbox = document.getElementById(`shift-${globalShifts.indexOf(shift)}`);
                    if (checkbox) checkbox.checked = false;
                }
            });
            updateStatistics();
        }

        function updateStatistics() {
            const availableShifts = globalShifts.filter(s => s.status === 'available');
            const selectedShifts = availableShifts.filter(s => s.selected);
            const totalHours = availableShifts.reduce((sum, s) => sum + s.duration, 0);
            const selectedHours = selectedShifts.reduce((sum, s) => sum + s.duration, 0);

            // 統計を更新
            document.querySelector('.stat-card:nth-child(2) .stat-number').textContent = selectedShifts.length;
            document.querySelector('.stat-card:nth-child(4) .stat-number').textContent = selectedHours.toFixed(1);
        }

        // シフト表生成
        function generateShiftTable() {
            const selectedShifts = globalShifts.filter(s => s.status === 'available' && s.selected);
            if (selectedShifts.length === 0) {
                alert('出勤日を選択してください。');
                return;
            }

            const userName = prompt('お名前を入力してください:', 'シフト希望者');
            if (!userName) return;

            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            // 新しいウィンドウでシフト表を開く
            const newWindow = window.open('', '_blank', 'width=800,height=600');
            
            const tableHtml = generateShiftTableHTML(selectedShifts, userName, startDate, endDate);
            
            newWindow.document.write(tableHtml);
            newWindow.document.close();
        }

        // シフト表HTMLの生成
        function generateShiftTableHTML(selectedShifts, userName, startDate, endDate) {
            const startDateObj = new Date(startDate);
            const endDateObj = new Date(endDate);
            
            // 対象となる月を特定
            const months = [];
            for (let d = new Date(startDateObj); d <= endDateObj; d.setMonth(d.getMonth() + 1)) {
                months.push({
                    year: d.getFullYear(),
                    month: d.getMonth() + 1
                });
                d.setDate(1); // 月の1日に設定して次の月へ
            }
            const tableStyle = `
                <style>
                    body { font-family: 'Yu Gothic', sans-serif; margin: 20px; }
                    .shift-table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                    .shift-table th, .shift-table td { border: 2px solid #333; padding: 12px; text-align: center; }
                    .shift-table th { background-color: #4CAF50; color: white; font-weight: bold; }
                    .available-day { background-color: #e8f5e8; font-weight: bold; }
                    .header { text-align: center; margin-bottom: 30px; }
                    .info-section { margin: 20px 0; padding: 15px; background-color: #f9f9f9; border-radius: 5px; }
                    @media print { 
                        body { margin: 0; } 
                        .no-print { display: none; }
                    }
                </style>
            `;

            const period = months.length === 1 ? 
                `${months[0].year}年${months[0].month}月` : 
                `${months[0].year}年${months[0].month}月〜${months[months.length-1].year}年${months[months.length-1].month}月`;
                
            const headerSection = `
                <div class="header">
                    <h1>🗓️ ${period} シフト希望表</h1>
                    <h2>👤 ${userName} 様</h2>
                    <p>作成日: ${new Date().toLocaleDateString('ja-JP')}</p>
                </div>
            `;

            const infoSection = `
                <div class="info-section">
                    <h3>📋 シフト希望詳細</h3>
                    <p><strong>希望者名:</strong> ${userName}</p>
                    <p><strong>対象期間:</strong> ${period}</p>
                    <p><strong>出勤可能日数:</strong> ${selectedShifts.length}日</p>
                    <p><strong>合計勤務時間:</strong> ${selectedShifts.reduce((sum, s) => sum + s.duration, 0).toFixed(1)}時間</p>
                </div>
            `;

            // 各月のカレンダーテーブルを生成
            let allCalendarTables = '';
            
            months.forEach((monthData, index) => {
                const { year, month } = monthData;
                const firstDay = new Date(year, month - 1, 1);
                const lastDay = new Date(year, month, 0);
                const daysInMonth = lastDay.getDate();
                const startDayOfWeek = firstDay.getDay();

                let tableRows = '';
                let currentWeek = [];
                
                // 空のセルで月の最初を埋める
                for (let i = 0; i < startDayOfWeek; i++) {
                    currentWeek.push('<td></td>');
                }

                // 各日のセルを生成
                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = new Date(year, month - 1, day);
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const dayName = ['日', '月', '火', '水', '木', '金', '土'][currentDate.getDay()];
                    
                    const selectedShift = selectedShifts.find(s => s.date === dateStr);
                    
                    if (selectedShift) {
                        currentWeek.push(`
                            <td class="available-day">
                                <div><strong>${day}</strong></div>
                                <div style="font-size: 0.9em;">(${dayName})</div>
                                <div style="font-size: 0.8em; color: #2e7d32;">
                                    ${selectedShift.availableTime}
                                </div>
                                <div style="font-size: 0.7em; color: #666;">
                                    ${selectedShift.duration.toFixed(1)}h
                                </div>
                            </td>
                        `);
                    } else {
                        currentWeek.push(`
                            <td>
                                <div>${day}</div>
                                <div style="font-size: 0.9em;">(${dayName})</div>
                            </td>
                        `);
                    }

                    // 週末（土曜日）で行を終了
                    if (currentDate.getDay() === 6) {
                        tableRows += '<tr>' + currentWeek.join('') + '</tr>';
                        currentWeek = [];
                    }
                }

                // 最後の週を完成させる
                if (currentWeek.length > 0) {
                    while (currentWeek.length < 7) {
                        currentWeek.push('<td></td>');
                    }
                    tableRows += '<tr>' + currentWeek.join('') + '</tr>';
                }

                // 各月のテーブル
                const monthTable = `
                    <div style="${index > 0 ? 'page-break-before: always; margin-top: 40px;' : ''}">
                        <h2 style="text-align: center; color: #1976D2; margin-bottom: 20px;">${year}年${month}月</h2>
                        <table class="shift-table">
                            <thead>
                                <tr>
                                    <th style="background-color: #ffcdd2;">日</th>
                                    <th>月</th>
                                    <th>火</th>
                                    <th>水</th>
                                    <th>木</th>
                                    <th>金</th>
                                    <th style="background-color: #c3e0ff;">土</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                `;
                
                allCalendarTables += monthTable;
            });
            
            const calendarTables = allCalendarTables;

            const detailTable = `
                <div style="margin-top: 30px;">
                    <h3>📝 出勤希望日一覧</h3>
                    <table class="shift-table">
                        <thead>
                            <tr>
                                <th>日付</th>
                                <th>曜日</th>
                                <th>出勤時間帯</th>
                                <th>勤務時間</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${selectedShifts.map(shift => `
                                <tr>
                                    <td>${shift.date}</td>
                                    <td>${shift.dayName}</td>
                                    <td>${shift.availableTime}</td>
                                    <td>${shift.duration.toFixed(1)}時間</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            const printButton = `
                <div class="no-print" style="text-align: center; margin-top: 30px;">
                    <button onclick="window.print()" style="
                        background: #4CAF50; color: white; border: none; 
                        padding: 15px 30px; border-radius: 5px; cursor: pointer;
                        font-size: 16px;">
                        🖨️ 印刷する
                    </button>
                    <button onclick="window.close()" style="
                        background: #f44336; color: white; border: none; 
                        padding: 15px 30px; border-radius: 5px; cursor: pointer;
                        font-size: 16px; margin-left: 10px;">
                        ❌ 閉じる
                    </button>
                </div>
            `;

            return `
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>シフト希望表 - ${userName}</title>
                    ${tableStyle}
                </head>
                <body>
                    ${headerSection}
                    ${infoSection}
                    ${calendarTables}
                    ${detailTable}
                    ${printButton}
                </body>
                </html>
            `;
        }

        // イベント詳細ツールチップ機能
        let eventTooltip = null;

        function showEventTooltip(event, shiftIndex) {
            const shift = globalShifts[shiftIndex];
            if (!shift || !shift.events || shift.events.length === 0) {
                return;
            }

            // 既存のツールチップを削除
            hideEventTooltip();

            // 新しいツールチップを作成
            eventTooltip = document.createElement('div');
            eventTooltip.className = 'event-tooltip';
            
            // ツールチップの内容を構築
            let tooltipContent = `<h4>📅 ${shift.date} の予定</h4>`;
            
            // 時間指定の予定
            const timeBasedEvents = shift.events.filter(e => !e.isAllDay);
            if (timeBasedEvents.length > 0) {
                timeBasedEvents.forEach(eventItem => {
                    tooltipContent += `
                        <div class="event-item">
                            <div class="event-title">⏰ ${eventItem.summary || 'タイトルなし'}</div>
                            <div class="event-time">${eventItem.start} - ${eventItem.end}</div>
                            ${eventItem.location ? `<div class="event-location">📍 ${eventItem.location}</div>` : ''}
                            ${eventItem.description ? `<div class="event-description">📝 ${eventItem.description}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            // 終日の予定
            const allDayEvents = shift.events.filter(e => e.isAllDay);
            if (allDayEvents.length > 0) {
                allDayEvents.forEach(eventItem => {
                    tooltipContent += `
                        <div class="event-item">
                            <div class="event-title">📅 ${eventItem.originalSummary || eventItem.summary || 'タイトルなし'}</div>
                            <div class="event-time">終日の予定</div>
                            ${eventItem.location ? `<div class="event-location">📍 ${eventItem.location}</div>` : ''}
                            ${eventItem.description ? `<div class="event-description">📝 ${eventItem.description}</div>` : ''}
                            ${eventItem.isMultiDay ? `<div class="event-time">期間: ${eventItem.eventStartDate} 〜 ${eventItem.eventEndDate}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            if (timeBasedEvents.length === 0 && allDayEvents.length === 0) {
                tooltipContent += '<div class="no-events">この日には予定がありません</div>';
            }
            
            eventTooltip.innerHTML = tooltipContent;
            document.body.appendChild(eventTooltip);
            
            // ツールチップの位置を設定
            const rect = event.target.closest('.shift-result').getBoundingClientRect();
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            
            eventTooltip.style.left = (rect.left + scrollLeft + 20) + 'px';
            eventTooltip.style.top = (rect.top + scrollTop - eventTooltip.offsetHeight - 10) + 'px';
            
            // 画面外にはみ出す場合の調整
            const tooltipRect = eventTooltip.getBoundingClientRect();
            if (tooltipRect.right > window.innerWidth) {
                eventTooltip.style.left = (window.innerWidth - tooltipRect.width - 20 + scrollLeft) + 'px';
            }
            if (tooltipRect.top < 0) {
                eventTooltip.style.top = (rect.bottom + scrollTop + 10) + 'px';
            }
            
            eventTooltip.style.display = 'block';
        }

        function hideEventTooltip() {
            if (eventTooltip) {
                document.body.removeChild(eventTooltip);
                eventTooltip = null;
            }
        }

        // CSV出力
        function exportToCSV() {
            const selectedShifts = globalShifts.filter(s => s.status === 'available' && s.selected);
            if (selectedShifts.length === 0) {
                alert('出勤日を選択してください。');
                return;
            }

            const csvContent = "data:text/csv;charset=utf-8," + 
                "日付,曜日,時間帯,勤務時間,予定\n" +
                selectedShifts.map(shift => 
                    `"${shift.date}","${shift.dayName}","${shift.availableTime}","${shift.duration.toFixed(1)}時間","${
                        shift.events && shift.events.length > 0 ? 
                        (() => {
                            const timeEvents = shift.events.filter(e => !e.isAllDay);
                            const allDayEvents = shift.events.filter(e => e.isAllDay);
                            let result = [];
                            if (timeEvents.length > 0) result.push(`時間指定: ${timeEvents.map(e => e.summary).join(', ')}`);
                            if (allDayEvents.length > 0) result.push(`終日: ${allDayEvents.map(e => e.summary).join(', ')}`);
                            return result.join(' | ');
                        })() : '-'
                    }"`
                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "shift_schedule.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>